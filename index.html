<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NagoyaGo - 日系極簡版</title>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet CSS & JS (For Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5; 
            -webkit-tap-highlight-color: transparent;
        }
        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #FAFAF9; /* Stone-50 */
            min-height: 100vh;
            min-height: 100dvh; /* Better mobile support */
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
        }

        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }

        .slide-right-enter-active, .slide-right-leave-active { transition: all 0.3s ease; }
        .slide-right-enter-from { opacity: 0; transform: translateX(20px); }
        .slide-right-leave-to { opacity: 0; transform: translateX(-20px); }
        
        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(45, 212, 191, 0.1);
            border-radius: 50%;
            border-top: 2px solid #2dd4bf;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scroll Snap for Date Tabs */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }

        /* Map Container */
        #map-container {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        /* Checkbox Animation */
        .checkbox-wrapper input:checked + div {
            background-color: #2dd4bf;
            border-color: #2dd4bf;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        
        /* Flight Card Gradient */
        .flight-card-bg {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lake: {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a',
                        },
                        sumi: '#44403c',
                        washi: '#fafaf9',
                        sand: '#f5f5f4',
                    },
                    borderRadius: { '4xl': '2rem' }
                }
            }
        }
    </script>
</head>
<body class="text-stone-600 bg-gray-100">

<div id="app">
    <div class="app-container h-[100dvh]">
        
        <!-- Header Section -->
        <header class="bg-washi/95 backdrop-blur-md px-6 pt-6 pb-2 z-20 sticky top-0 border-b border-stone-100 transition-all duration-300" :class="{'shadow-sm': isScrolled}">
            <!-- Top Bar -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1 mr-4">
                    <div class="flex items-center gap-2 mb-1">
                        <!-- Editable Title Input -->
                        <input 
                            v-model="tripTitle" 
                            @blur="saveToCloud()"
                            @keydown.enter="$event.target.blur()"
                            type="text"
                            class="text-2xl font-bold text-sumi tracking-wider bg-transparent border-none outline-none w-full p-0 placeholder-stone-300 focus:ring-0"
                            placeholder="輸入行程名稱..."
                        >
                        <!-- Sync Indicator -->
                        <div class="flex-shrink-0 mt-1">
                            <span v-if="status === 'loading'" class="spinner"></span>
                            <span v-else-if="status === 'connected'" class="flex h-2 w-2 relative" title="已連線">
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-lake-300"></span>
                            </span>
                            <span v-else class="h-2 w-2 rounded-full bg-red-300" title="未連線"></span>
                        </div>
                    </div>
                    <p class="text-xs text-stone-400 font-normal mt-0.5 tracking-widest uppercase">JAPAN TRAVEL PLANNER</p>
                </div>
                
                <!-- Action Buttons (Only show in Itinerary mode) -->
                <div class="flex gap-2" v-if="currentTab === 'itinerary'">
                    <button @click="toggleViewMode" class="w-20 h-8 rounded-full bg-white border border-stone-100 text-stone-400 hover:text-lake-500 hover:border-lake-200 flex items-center justify-center transition-all shadow-sm gap-1 text-xs font-bold">
                        <i class="fa-solid" :class="viewMode === 'list' ? 'fa-map' : 'fa-list-ul'"></i>
                        <span>{{ viewMode === 'list' ? 'Map' : 'List' }}</span>
                    </button>
                    <button @click="resetData" class="w-8 h-8 rounded-full bg-white border border-stone-100 text-stone-300 hover:text-red-400 hover:border-red-100 flex items-center justify-center transition-colors shadow-sm">
                        <i class="fa-solid fa-rotate-right text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Date Range (Minimalist) -->
            <div class="flex items-center justify-between bg-white rounded-2xl p-1 pr-4 pl-4 mb-3 shadow-[0_2px_10px_rgba(0,0,0,0.02)] border border-stone-50">
                <div class="flex flex-col">
                    <span class="text-[10px] text-lake-400 font-bold tracking-widest uppercase">Departure</span>
                    <input type="date" v-model="startDate" @change="handleDateChange" class="text-sm font-bold text-sumi bg-transparent border-none outline-none p-0 w-28 font-mono">
                </div>
                <div class="w-px h-6 bg-stone-100 mx-2"></div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-stone-300 font-bold tracking-widest uppercase">Return</span>
                    <input type="date" v-model="endDate" @change="handleDateChange" class="text-sm font-bold text-stone-400 bg-transparent border-none outline-none p-0 w-28 text-right font-mono">
                </div>
            </div>

            <!-- Main Tab Navigation -->
            <div class="flex bg-stone-100 p-1 rounded-xl mb-3">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click="currentTab = tab.id"
                    class="flex-1 py-2 text-xs font-bold rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5"
                    :class="currentTab === tab.id ? 'bg-white text-sumi shadow-sm' : 'text-stone-400 hover:text-stone-500'"
                >
                    <i :class="tab.icon"></i>
                    {{ tab.label }}
                </button>
            </div>

            <!-- Day Selector (Only visible in Itinerary tab) -->
            <div v-if="currentTab === 'itinerary'" class="relative -mx-6 transition-all duration-300"> 
                <div class="flex overflow-x-auto no-scrollbar snap-x-mandatory px-6 pb-2 gap-4" id="day-scroller">
                    <button 
                        v-for="(day, index) in days" 
                        :key="index"
                        @click="changeDay(index)"
                        class="snap-center flex-shrink-0 relative py-2 transition-all duration-300 group"
                    >
                        <div 
                            class="px-5 py-2 rounded-2xl text-sm transition-all duration-300 flex flex-col items-center min-w-[70px]"
                            :class="currentDayIndex === index ? 'bg-lake-400 text-white shadow-lg shadow-lake-200 scale-100' : 'bg-white text-stone-400 border border-stone-100 group-hover:border-lake-200'"
                        >
                            <span class="font-bold tracking-wide">Day {{ index + 1 }}</span>
                            <span class="text-[10px] font-normal mt-0.5 opacity-90">{{ getDayDateString(index, true) }}</span>
                        </div>
                    </button>
                    
                    <button @click="manualAddDay" class="snap-center flex-shrink-0 px-4 py-2 flex items-center justify-center">
                        <div class="w-10 h-10 rounded-full bg-white border border-dashed border-lake-300 text-lake-400 flex items-center justify-center hover:bg-lake-50 transition-colors">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                    </button>
                    <div class="w-2 flex-shrink-0"></div>
                </div>
                <div class="absolute right-0 top-0 bottom-2 w-8 bg-gradient-to-l from-washi to-transparent pointer-events-none"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-hidden relative bg-washi">
            
            <!-- ====== ITINERARY TAB ====== -->
            <div v-if="currentTab === 'itinerary'" class="h-full relative">
                <!-- LIST VIEW -->
                <div v-show="viewMode === 'list'" class="absolute inset-0 overflow-y-auto p-4 pb-24" @scroll="checkScroll">
                    
                    <!-- ARRIVAL FLIGHT CARD (Only Day 1) -->
                    <div v-if="currentDayIndex === 0" class="mb-6">
                        <div class="relative pl-10">
                            <!-- Flight Icon Dot -->
                            <div class="absolute left-0 top-6 w-10 h-10 flex items-center justify-center z-10">
                                <div class="w-8 h-8 rounded-full bg-lake-100 text-lake-500 flex items-center justify-center ring-4 ring-washi shadow-sm">
                                    <i class="fa-solid fa-plane-arrival text-xs"></i>
                                </div>
                            </div>
                            
                            <!-- Empty State: Button -->
                            <div v-if="!arrivalFlight.code" class="bg-white p-5 rounded-[24px] shadow-[0_2px_15px_rgba(0,0,0,0.02)] border border-stone-50 border-dashed border-lake-200 flex items-center justify-center">
                                <button @click="openFlightModal('arrival')" class="flex items-center gap-2 text-lake-400 font-bold bg-lake-50 px-6 py-3 rounded-xl hover:bg-lake-100 transition-colors">
                                    <i class="fa-solid fa-plus"></i>
                                    設定去程航班資訊 (Manual)
                                </button>
                            </div>

                            <!-- Filled State: Flight Ticket Card -->
                            <div v-else class="flight-card-bg p-5 rounded-[24px] shadow-md border border-white relative overflow-hidden group">
                                <div class="flex justify-between items-start relative z-10">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="bg-lake-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">Arrival</span>
                                            <span class="text-lake-600 font-bold text-lg font-mono">{{ arrivalFlight.code }}</span>
                                        </div>
                                        <h3 class="text-sumi font-bold text-sm mb-0.5">{{ arrivalFlight.title }}</h3>
                                        <p class="text-xs text-stone-400">{{ arrivalFlight.location }}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-sumi font-mono tracking-tight">{{ arrivalFlight.time }}</div>
                                        <div class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Estimated</div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-lake-100 flex items-center justify-between text-xs text-stone-500 relative z-10">
                                    <span class="flex items-center gap-1.5"><i class="fa-regular fa-clock text-lake-400"></i> {{ arrivalFlight.note }}</span>
                                    <button @click="openFlightModal('arrival')" class="text-stone-300 hover:text-lake-500 transition-colors px-2 py-1"><i class="fa-solid fa-pen"></i></button>
                                </div>
                                <!-- Decor -->
                                <i class="fa-solid fa-plane absolute -bottom-4 -right-4 text-[100px] text-lake-50 opacity-50 transform -rotate-45 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Weather Card -->
                    <transition name="fade">
                        <div v-if="currentDayWeatherSummary" class="mb-6 bg-gradient-to-br from-white to-lake-50 rounded-3xl p-5 shadow-sm border border-white flex justify-between items-center relative overflow-hidden group">
                            <div class="absolute -right-4 -top-4 w-20 h-20 bg-lake-100 rounded-full opacity-50 blur-2xl group-hover:scale-125 transition-transform duration-700"></div>
                            <div class="z-10">
                                <p class="text-[10px] font-bold text-lake-400 tracking-widest uppercase mb-1">Weather Forecast</p>
                                <div class="flex items-baseline gap-2">
                                    <span class="text-3xl font-bold text-sumi tracking-tight">{{ currentDayWeatherSummary.max }}°</span>
                                    <span class="text-sm text-stone-400 font-normal">/ {{ currentDayWeatherSummary.min }}°</span>
                                </div>
                            </div>
                            <div class="z-10 text-lake-400 bg-white/60 backdrop-blur-sm p-3 rounded-2xl shadow-sm">
                                <i class="fa-solid fa-cloud-sun text-xl"></i>
                            </div>
                        </div>
                    </transition>

                    <!-- Empty State -->
                    <div v-if="currentDayEvents.length === 0" class="flex flex-col items-center justify-center py-20 text-stone-300">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-[0_4px_20px_rgba(0,0,0,0.03)] mb-4 animate-pulse">
                            <i class="fa-regular fa-map text-2xl text-lake-200"></i>
                        </div>
                        <p class="font-normal tracking-widest text-sm">PLAN YOUR JOURNEY</p>
                    </div>

                    <!-- Timeline & Events -->
                    <div v-else class="space-y-6 relative">
                        <div class="absolute left-[19px] top-0 bottom-0 w-px bg-stone-200/60"></div>

                        <transition-group name="slide-right" tag="div" class="space-y-6">
                            <div v-for="event in sortedEvents" :key="event.id" class="relative pl-10 group">
                                <!-- Timeline Dot -->
                                <div class="absolute left-0 top-3 w-10 h-10 flex items-center justify-center z-10">
                                    <div class="w-2.5 h-2.5 rounded-full ring-4 ring-washi transition-colors duration-300" :class="getTypeColor(event.type, 'dot')"></div>
                                </div>
                                <!-- Card -->
                                <div class="bg-white p-5 rounded-[24px] shadow-[0_2px_15px_rgba(0,0,0,0.02)] border border-stone-50 active:scale-[0.98] transition-all duration-200 relative overflow-hidden hover:shadow-md" @click="editEvent(event)">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center gap-2">
                                            <span class="text-xs font-bold font-mono tracking-tight" :class="getTypeColor(event.type, 'text')">{{ event.time }}</span>
                                            <span class="px-2 py-0.5 rounded-full text-[10px] font-medium tracking-wide bg-stone-50 text-stone-400 uppercase">{{ getTypeName(event.type) }}</span>
                                        </div>
                                        <a :href="getMapUrl(event.location)" target="_blank" @click.stop class="w-8 h-8 flex items-center justify-center rounded-full bg-stone-50 text-stone-300 hover:bg-lake-50 hover:text-lake-400 transition-colors">
                                            <i class="fa-solid fa-location-arrow text-xs"></i>
                                        </a>
                                    </div>
                                    <h3 class="text-lg font-bold text-sumi mb-1 leading-snug">{{ event.title }}</h3>
                                    <div class="flex items-center text-stone-400 text-xs mb-3 font-normal">
                                        <i class="fa-solid fa-location-dot mr-1.5 opacity-50"></i>
                                        <span class="truncate">{{ event.location }}</span>
                                    </div>
                                    <div v-if="getEventWeather(event.time)" class="absolute bottom-4 right-4 flex items-center text-xs text-lake-400 bg-lake-50/50 px-2 py-1 rounded-lg backdrop-blur-sm">
                                        <i :class="getWeatherIcon(getEventWeather(event.time).code)" class="mr-1.5"></i>
                                        <span>{{ getEventWeather(event.time).temp }}°</span>
                                    </div>
                                    <p v-if="event.note" class="text-stone-400 text-xs mt-3 pt-3 border-t border-stone-50/80 line-clamp-2 leading-relaxed font-normal">{{ event.note }}</p>
                                </div>
                            </div>
                        </transition-group>
                    </div>

                    <!-- DEPARTURE FLIGHT CARD (Only Last Day) -->
                    <div v-if="currentDayIndex === days.length - 1" class="mt-6">
                        <div class="relative pl-10">
                            <!-- Flight Icon Dot -->
                            <div class="absolute left-0 top-6 w-10 h-10 flex items-center justify-center z-10">
                                <div class="w-8 h-8 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center ring-4 ring-washi shadow-sm">
                                    <i class="fa-solid fa-plane-departure text-xs"></i>
                                </div>
                            </div>
                            
                            <!-- Empty State -->
                            <div v-if="!departureFlight.code" class="bg-white p-5 rounded-[24px] shadow-[0_2px_15px_rgba(0,0,0,0.02)] border border-stone-50 border-dashed border-stone-200 flex items-center justify-center">
                                <button @click="openFlightModal('departure')" class="flex items-center gap-2 text-stone-400 font-bold bg-stone-50 px-6 py-3 rounded-xl hover:bg-stone-100 transition-colors">
                                    <i class="fa-solid fa-plus"></i>
                                    設定回程航班資訊 (Manual)
                                </button>
                            </div>

                            <!-- Filled State -->
                            <div v-else class="flight-card-bg p-5 rounded-[24px] shadow-md border border-white relative overflow-hidden group">
                                <div class="flex justify-between items-start relative z-10">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="bg-stone-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">Return</span>
                                            <span class="text-stone-600 font-bold text-lg font-mono">{{ departureFlight.code }}</span>
                                        </div>
                                        <h3 class="text-sumi font-bold text-sm mb-0.5">{{ departureFlight.title }}</h3>
                                        <p class="text-xs text-stone-400">{{ departureFlight.location }}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-sumi font-mono tracking-tight">{{ departureFlight.time }}</div>
                                        <div class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Departure</div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-lake-100 flex items-center justify-between text-xs text-stone-500 relative z-10">
                                    <span class="flex items-center gap-1.5"><i class="fa-regular fa-clock text-stone-400"></i> {{ departureFlight.note }}</span>
                                    <button @click="openFlightModal('departure')" class="text-stone-300 hover:text-stone-500 transition-colors px-2 py-1"><i class="fa-solid fa-pen"></i></button>
                                </div>
                                <i class="fa-solid fa-plane-departure absolute -bottom-4 -right-4 text-[100px] text-stone-100 opacity-50 transform -rotate-12 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- MAP VIEW -->
                <div v-show="viewMode === 'map'" class="absolute inset-0 bg-stone-100">
                    <div id="map-container"></div>
                    <div v-if="isMapLoading" class="absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-lg z-[1000] flex items-center gap-2 text-xs font-bold text-lake-500">
                        <div class="spinner w-3 h-3 border-t-lake-500"></div>
                        <span>Locating...</span>
                    </div>
                    <div v-if="currentDayEvents.length === 0" class="absolute inset-0 flex items-center justify-center pointer-events-none z-[1000]">
                        <div class="bg-white/80 backdrop-blur px-6 py-4 rounded-2xl shadow-xl text-center">
                            <p class="text-stone-500 font-bold">No locations yet</p>
                            <p class="text-xs text-stone-400">Switch to list to add events</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== XUAN SHOPPING LIST TAB ====== -->
            <div v-if="currentTab === 'xuan'" class="absolute inset-0 overflow-y-auto p-4 pb-24 bg-washi">
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-stone-50 min-h-[400px]">
                    <h2 class="text-xl font-bold text-sumi mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-pink-100 text-pink-500 flex items-center justify-center text-sm"><i class="fa-solid fa-bag-shopping"></i></span>
                        Xuan 的購物清單
                    </h2>
                    
                    <div class="flex gap-2 mb-6">
                        <input v-model="newItemXuan" @keydown.enter="addShoppingItem('xuan')" type="text" placeholder="想買什麼？ (Enter 新增)" class="flex-1 bg-stone-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-pink-200 transition-all outline-none">
                        <button @click="addShoppingItem('xuan')" class="w-12 h-11 rounded-xl bg-pink-400 text-white shadow-lg shadow-pink-200 hover:bg-pink-500 transition-colors flex items-center justify-center">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>

                    <div class="space-y-3">
                        <transition-group name="slide-right">
                            <div v-for="item in xuanList" :key="item.id" class="flex items-center gap-3 p-3 rounded-xl bg-stone-50 group hover:bg-white hover:shadow-sm border border-transparent hover:border-stone-100 transition-all">
                                <label class="checkbox-wrapper cursor-pointer relative w-6 h-6">
                                    <input type="checkbox" v-model="item.checked" @change="saveToCloud()" class="opacity-0 absolute w-full h-full cursor-pointer">
                                    <div class="w-6 h-6 border-2 border-stone-300 rounded-lg flex items-center justify-center transition-all bg-white">
                                        <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                </label>
                                <span class="flex-1 text-sm font-medium transition-all" :class="item.checked ? 'text-stone-300 line-through' : 'text-sumi'">{{ item.text }}</span>
                                <button @click="deleteShoppingItem('xuan', item.id)" class="text-stone-300 hover:text-red-400 p-2 rounded-full hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </transition-group>
                        <div v-if="xuanList.length === 0" class="text-center py-10 text-stone-300 text-xs tracking-widest">
                            EMPTY LIST
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== CHIAU SHOPPING LIST TAB ====== -->
            <div v-if="currentTab === 'chiau'" class="absolute inset-0 overflow-y-auto p-4 pb-24 bg-washi">
                <div class="bg-white p-6 rounded-[32px] shadow-sm border border-stone-50 min-h-[400px]">
                    <h2 class="text-xl font-bold text-sumi mb-4 flex items-center gap-2">
                        <span class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-500 flex items-center justify-center text-sm"><i class="fa-solid fa-cart-shopping"></i></span>
                        Chiau 的購物清單
                    </h2>
                    
                    <div class="flex gap-2 mb-6">
                        <input v-model="newItemChiau" @keydown.enter="addShoppingItem('chiau')" type="text" placeholder="想買什麼？ (Enter 新增)" class="flex-1 bg-stone-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-200 transition-all outline-none">
                        <button @click="addShoppingItem('chiau')" class="w-12 h-11 rounded-xl bg-indigo-400 text-white shadow-lg shadow-indigo-200 hover:bg-indigo-500 transition-colors flex items-center justify-center">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>

                    <div class="space-y-3">
                        <transition-group name="slide-right">
                            <div v-for="item in chiauList" :key="item.id" class="flex items-center gap-3 p-3 rounded-xl bg-stone-50 group hover:bg-white hover:shadow-sm border border-transparent hover:border-stone-100 transition-all">
                                <label class="checkbox-wrapper cursor-pointer relative w-6 h-6">
                                    <input type="checkbox" v-model="item.checked" @change="saveToCloud()" class="opacity-0 absolute w-full h-full cursor-pointer">
                                    <div class="w-6 h-6 border-2 border-stone-300 rounded-lg flex items-center justify-center transition-all bg-white">
                                        <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                    </div>
                                </label>
                                <span class="flex-1 text-sm font-medium transition-all" :class="item.checked ? 'text-stone-300 line-through' : 'text-sumi'">{{ item.text }}</span>
                                <button @click="deleteShoppingItem('chiau', item.id)" class="text-stone-300 hover:text-red-400 p-2 rounded-full hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100">
                                    <i class="fa-solid fa-trash-can"></i>
                                </button>
                            </div>
                        </transition-group>
                        <div v-if="chiauList.length === 0" class="text-center py-10 text-stone-300 text-xs tracking-widest">
                            EMPTY LIST
                        </div>
                    </div>
                </div>
            </div>

        </main>

        <!-- FAB (Floating Action Button) - Only show in Itinerary List mode -->
        <transition name="fade">
            <button 
                v-if="currentTab === 'itinerary' && viewMode === 'list'"
                @click="openAddModal" 
                class="absolute bottom-8 right-6 w-14 h-14 bg-lake-400 text-white rounded-[20px] shadow-xl shadow-lake-300/40 flex items-center justify-center text-xl hover:bg-lake-500 hover:scale-105 active:scale-95 transition-all z-30"
            >
                <i class="fa-solid fa-plus"></i>
            </button>
        </transition>

        <!-- Edit/Add Event Modal (Standard) -->
        <transition name="slide-up">
            <div v-if="showModal && !isFlightMode" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div @click="closeModal" class="absolute inset-0 bg-stone-900/20 backdrop-blur-sm pointer-events-auto transition-opacity"></div>
                
                <div class="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-8 pointer-events-auto shadow-2xl relative max-h-[90vh] overflow-y-auto">
                    <div class="w-12 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-xl font-bold text-sumi tracking-wide">{{ isEditing ? 'Edit Event' : 'New Event' }}</h2>
                    </div>

                    <form @submit.prevent="saveEvent" class="space-y-6">
                        <div class="grid grid-cols-5 gap-4">
                            <div class="col-span-2">
                                <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">Time</label>
                                <input v-model="form.time" type="time" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi font-mono text-sm focus:ring-2 focus:ring-lake-200 transition-shadow">
                            </div>
                            <div class="col-span-3">
                                <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">Category</label>
                                <div class="relative">
                                    <select v-model="form.type" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm appearance-none focus:ring-2 focus:ring-lake-200 transition-shadow">
                                        <option value="sightseeing">景點 Sightseeing</option>
                                        <option value="food">美食 Food</option>
                                        <option value="shopping">購物 Shopping</option>
                                        <option value="transport">交通 Transport</option>
                                        <option value="hotel">住宿 Hotel</option>
                                    </select>
                                    <i class="fa-solid fa-chevron-down absolute right-4 top-3.5 text-stone-300 text-xs pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">Title</label>
                            <input v-model="form.title" type="text" placeholder="What are you doing?" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow">
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">Location</label>
                            <div class="relative">
                                <input v-model="form.location" type="text" placeholder="Where is it?" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 pl-10 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow">
                                <i class="fa-solid fa-map-pin absolute left-4 top-3.5 text-stone-300 text-sm"></i>
                            </div>
                            <p class="text-[10px] text-stone-400 mt-1 ml-1" v-if="isEditing && !form.lat">
                                * 輸入地點名稱後，系統將嘗試在地圖模式下自動定位。
                            </p>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">Notes</label>
                            <textarea v-model="form.note" rows="3" placeholder="Any details..." class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow resize-none"></textarea>
                        </div>

                        <div class="pt-6 flex gap-3">
                            <button v-if="isEditing" type="button" @click="deleteEvent" class="w-12 h-12 rounded-xl bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition-colors">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                            <button type="submit" class="flex-1 bg-lake-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-lake-200 hover:bg-lake-500 transition-all">
                                {{ isEditing ? 'Save Changes' : 'Add to Plan' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

        <!-- Edit/Add FLIGHT Modal (Manual Input Only) -->
        <transition name="slide-up">
            <div v-if="showModal && isFlightMode" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div @click="closeModal" class="absolute inset-0 bg-stone-900/20 backdrop-blur-sm pointer-events-auto transition-opacity"></div>
                
                <div class="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-8 pointer-events-auto shadow-2xl relative max-h-[90vh] overflow-y-auto">
                    <div class="w-12 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-xl font-bold text-sumi tracking-wide">
                            {{ editingFlightType === 'arrival' ? '去程航班' : '回程航班' }}
                        </h2>
                    </div>

                    <form @submit.prevent="saveFlight" class="space-y-6">
                        <!-- Flight Code -->
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">航班代號 (Flight Code)</label>
                            <input v-model="flightForm.code" type="text" placeholder="e.g. JX838" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow uppercase font-mono">
                        </div>

                        <!-- Airline/Title -->
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">航空公司 / 標題</label>
                            <input v-model="flightForm.title" type="text" placeholder="e.g. 星宇航空" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow">
                        </div>

                        <!-- Time Range (Text) -->
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">起降時間 (Time Range)</label>
                            <input v-model="flightForm.time" type="text" placeholder="e.g. 14:55 - 18:30" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow">
                        </div>

                        <!-- Location -->
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">機場 / 地點</label>
                            <div class="relative">
                                <input v-model="flightForm.location" type="text" placeholder="e.g. 中部國際機場 (NGO)" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 pl-10 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow">
                                <i class="fa-solid fa-map-pin absolute left-4 top-3.5 text-stone-300 text-sm"></i>
                            </div>
                        </div>

                        <!-- Note -->
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">備註 / 航廈</label>
                            <textarea v-model="flightForm.note" rows="3" placeholder="e.g. 第二航廈, 提早2小時報到..." class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow resize-none"></textarea>
                        </div>

                        <div class="pt-6 flex gap-3">
                            <button type="button" @click="clearFlightData" class="w-12 h-12 rounded-xl bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition-colors">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                            <button type="submit" class="flex-1 bg-lake-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-lake-200 hover:bg-lake-500 transition-all">
                                儲存航班資訊
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- Supabase Config ---
            const SUPABASE_URL = 'https://nrormwhklkytqyrbrdbr.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_QuvW2VoIHavfZ7RunbOl1A_Fu34ri_D';

            // --- State ---
            const days = ref([]);
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const isEditing = ref(false);
            const isFlightMode = ref(false); // New flag for flight modal
            const editingFlightType = ref(''); // 'arrival' or 'departure'
            const tripTitle = ref('Nagoya.Go');
            
            // Special Flights
            const arrivalFlight = ref({ code: '', time: '', title: '', location: '', note: '', lat: null, lng: null });
            const departureFlight = ref({ code: '', time: '', title: '', location: '', note: '', lat: null, lng: null });
            
            // Flight Form Data
            const flightForm = ref({ code: '', time: '', title: '', location: '', note: '' });

            // Tab State
            const currentTab = ref('itinerary'); 
            const tabs = [
                { id: 'itinerary', label: '行程', icon: 'fa-solid fa-calendar-days' },
                { id: 'xuan', label: 'Xuan', icon: 'fa-solid fa-user' },
                { id: 'chiau', label: 'Chiau', icon: 'fa-solid fa-user' },
            ];

            // Shopping Lists
            const xuanList = ref([]);
            const chiauList = ref([]);
            const newItemXuan = ref('');
            const newItemChiau = ref('');
            
            // View Mode State
            const viewMode = ref('list'); 
            const isScrolled = ref(false);
            const isMapLoading = ref(false);
            let map = null;
            let markers = [];

            // Date State
            const startDate = ref(new Date().toISOString().split('T')[0]); 
            const endDate = ref(''); 
            const weatherData = ref(null);
            
            // Supabase State
            const status = ref('disconnected'); 
            let supabase = null;
            let tripChannel = null;
            const TRIP_ID = 'nagoya_main'; 

            // Standard Event Form State
            const form = ref({ id: null, time: '09:00', type: 'sightseeing', title: '', location: '', note: '', lat: null, lng: null });

            // --- Default Data ---
            const defaultStartDate = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultEndDate = tomorrow.toISOString().split('T')[0];

            const defaultData = {
                tripTitle: 'Nagoya.Go',
                startDate: defaultStartDate,
                endDate: defaultEndDate,
                xuanList: [],
                chiauList: [],
                arrivalFlight: { code: '' },
                departureFlight: { code: '' },
                days: [
                    {
                        date: 'Day 1',
                        events: [
                            { id: 2, time: '12:00', type: 'food', title: '矢場炸豬排', location: 'Yabaton Nagoya Station Esca', note: '必點鐵板味噌豬排', lat: 35.1709, lng: 136.8815 },
                            { id: 3, time: '14:30', type: 'sightseeing', title: '名古屋城', location: 'Nagoya Castle', note: '參觀本丸御殿，看金鯱', lat: 35.1838, lng: 136.9003 },
                        ]
                    },
                    {
                        date: 'Day 2',
                        events: [
                            { id: 5, time: '09:00', type: 'sightseeing', title: '熱田神宮', location: 'Atsuta Jingu', note: '日本三大神宮之一', lat: 35.1256, lng: 136.9088 },
                        ]
                    }
                ]
            };

            // --- Flight Logic (Manual) ---
            const openFlightModal = (type) => {
                isFlightMode.value = true;
                editingFlightType.value = type;
                
                // Pre-fill form if data exists
                const target = type === 'arrival' ? arrivalFlight.value : departureFlight.value;
                flightForm.value = { ...target };
                
                showModal.value = true;
            };

            const saveFlight = () => {
                const target = editingFlightType.value === 'arrival' ? arrivalFlight : departureFlight;
                
                target.value = {
                    ...target.value, // keep lat/lng if existing
                    code: flightForm.value.code.toUpperCase(),
                    title: flightForm.value.title,
                    time: flightForm.value.time,
                    location: flightForm.value.location,
                    note: flightForm.value.note
                };
                
                // Try to geocode if location changed (simple check)
                if (flightForm.value.location) {
                    // This is async but we don't await it to close modal fast
                    fetchCoordinates(flightForm.value.location).then(coords => {
                        if(coords) {
                            target.value.lat = coords.lat;
                            target.value.lng = coords.lng;
                            saveToCloud(); // Save again with coords
                        }
                    });
                }

                saveToCloud();
                closeModal();
            };

            const clearFlightData = () => {
                if(!confirm('確定清除此航班資訊嗎？')) return;
                const target = editingFlightType.value === 'arrival' ? arrivalFlight : departureFlight;
                target.value = { code: '', time: '', title: '', location: '', note: '', lat: null, lng: null };
                saveToCloud();
                closeModal();
            };

            // --- Shopping List Logic ---
            const addShoppingItem = (who) => {
                const text = who === 'xuan' ? newItemXuan.value.trim() : newItemChiau.value.trim();
                if (!text) return;
                const item = { id: Date.now(), text, checked: false };
                if (who === 'xuan') { xuanList.value.push(item); newItemXuan.value = ''; } 
                else { chiauList.value.push(item); newItemChiau.value = ''; }
                saveToCloud();
            };

            const deleteShoppingItem = (who, id) => {
                if (!confirm('確定刪除此項目嗎？')) return;
                if (who === 'xuan') { const idx = xuanList.value.findIndex(i => i.id === id); if (idx !== -1) xuanList.value.splice(idx, 1); } 
                else { const idx = chiauList.value.findIndex(i => i.id === id); if (idx !== -1) chiauList.value.splice(idx, 1); }
                saveToCloud();
            };

            // --- Map Logic ---
            const toggleViewMode = () => {
                viewMode.value = viewMode.value === 'list' ? 'map' : 'list';
                if (viewMode.value === 'map') { nextTick(() => { initMap(); renderMapMarkers(); }); }
            };

            const initMap = () => {
                if (map) return; 
                map = L.map('map-container').setView([35.1709, 136.8815], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap & CARTO', subdomains: 'abcd', maxZoom: 19 }).addTo(map);
                renderMapMarkers();
            };

            const fetchCoordinates = async (address) => {
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                    const data = await response.json();
                    if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                } catch (e) { console.error("Geocoding failed for:", address); }
                return null;
            };

            const renderMapMarkers = async () => {
                if (!map) return;
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];

                const events = days.value[currentDayIndex.value]?.events || [];
                
                // Add Flight Markers if on Day 1 or Last Day
                if (currentDayIndex.value === 0 && arrivalFlight.value.lat) {
                    const m = L.marker([arrivalFlight.value.lat, arrivalFlight.value.lng]).addTo(map)
                        .bindPopup(`<div class="text-center font-bold text-lake-500">✈️ Arrival: ${arrivalFlight.value.code}</div>`);
                    markers.push(m);
                }
                if (currentDayIndex.value === days.value.length - 1 && departureFlight.value.lat) {
                    const m = L.marker([departureFlight.value.lat, departureFlight.value.lng]).addTo(map)
                        .bindPopup(`<div class="text-center font-bold text-stone-500">✈️ Departure: ${departureFlight.value.code}</div>`);
                    markers.push(m);
                }

                if (events.length === 0 && markers.length === 0) return;

                isMapLoading.value = true;
                const bounds = L.latLngBounds();
                let hasValidLocation = false;

                // Include flight markers in bounds
                if (markers.length > 0) markers.forEach(m => bounds.extend(m.getLatLng()));

                for (const event of events) {
                    if ((!event.lat || !event.lng) && event.location) {
                        const coords = await fetchCoordinates(event.location);
                        if (coords) { event.lat = coords.lat; event.lng = coords.lng; saveToCloud(); }
                    }
                    if (event.lat && event.lng) {
                        hasValidLocation = true;
                        const marker = L.marker([event.lat, event.lng]).addTo(map)
                            .bindPopup(`<div class="text-center"><div class="text-xs font-bold text-lake-500 mb-1">${event.time}</div><div class="font-bold text-sumi">${event.title}</div></div>`);
                        markers.push(marker);
                        bounds.extend([event.lat, event.lng]);
                    }
                }
                if (hasValidLocation || markers.length > 0) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
                isMapLoading.value = false;
            };

            watch(currentDayIndex, () => {
                if (viewMode.value === 'map') renderMapMarkers();
            });

            // --- Navigation Logic ---
            const scrollToDay = (index) => {
                changeDay(index);
                const container = document.getElementById('day-scroller');
                const buttons = container.querySelectorAll('button');
                if (buttons[index]) buttons[index].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            };
            const changeDay = (index) => currentDayIndex.value = index;
            const checkScroll = (e) => isScrolled.value = e.target.scrollTop > 10;

            // --- Date Logic ---
            const calculateEndDateFromDays = () => {
                if (startDate.value && days.value.length > 0) {
                    const start = new Date(startDate.value);
                    const end = new Date(start);
                    end.setDate(start.getDate() + days.value.length - 1);
                    endDate.value = end.toISOString().split('T')[0];
                }
            };

            const handleDateChange = () => {
                if (!startDate.value || !endDate.value) return;
                const start = new Date(startDate.value);
                const end = new Date(endDate.value);
                if (end < start) { alert("回程日期不能早於出發日期！"); calculateEndDateFromDays(); return; }
                const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                const currentCount = days.value.length;
                if (diffDays > currentCount) {
                    for (let i = currentCount; i < diffDays; i++) days.value.push({ date: `Day ${i + 1}`, events: [] });
                } else if (diffDays < currentCount) {
                    if (confirm(`縮短行程將刪除 Day ${diffDays + 1} 後的所有行程，確定嗎？`)) {
                        days.value = days.value.slice(0, diffDays);
                        if (currentDayIndex.value >= days.value.length) currentDayIndex.value = days.value.length - 1;
                    } else { calculateEndDateFromDays(); return; }
                }
                fetchWeather();
                saveToCloud();
            };

            // --- Supabase Logic ---
            const initSupabase = async () => {
                if (!SUPABASE_URL || !SUPABASE_URL.startsWith('http') || SUPABASE_URL.includes('請在此填入')) {
                    status.value = 'disconnected'; loadLocalDefault(); return;
                }
                try {
                    status.value = 'loading';
                    const { createClient } = window.supabase;
                    supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                    const { data, error } = await supabase.from('trip_plans').select('content').eq('id', TRIP_ID).maybeSingle();
                    if (error) throw error;
                    status.value = 'connected';
                    if (data && data.content) {
                        days.value = data.content.days || [];
                        startDate.value = data.content.startDate || defaultStartDate;
                        if (data.content.endDate) endDate.value = data.content.endDate; else calculateEndDateFromDays();
                        if (data.content.tripTitle) tripTitle.value = data.content.tripTitle;
                        
                        xuanList.value = data.content.xuanList || [];
                        chiauList.value = data.content.chiauList || [];
                        
                        // Load Flights
                        if (data.content.arrivalFlight) arrivalFlight.value = data.content.arrivalFlight;
                        if (data.content.departureFlight) departureFlight.value = data.content.departureFlight;

                        fetchWeather();
                    } else {
                        loadLocalDefault(); saveToCloud(true);
                    }
                    subscribeToRealtime();
                } catch (e) {
                    console.error("Supabase Error:", e); status.value = 'disconnected'; loadLocalDefault();
                }
            };

            const loadLocalDefault = () => {
                days.value = defaultData.days;
                startDate.value = defaultData.startDate;
                endDate.value = defaultData.endDate;
                tripTitle.value = defaultData.tripTitle;
                xuanList.value = defaultData.xuanList;
                chiauList.value = defaultData.chiauList;
                arrivalFlight.value = defaultData.arrivalFlight;
                departureFlight.value = defaultData.departureFlight;
                fetchWeather();
            }

            const subscribeToRealtime = () => {
                if (tripChannel) supabase.removeChannel(tripChannel);
                tripChannel = supabase.channel('room_nagoya')
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'trip_plans', filter: `id=eq.${TRIP_ID}` }, (payload) => {
                        const content = payload.new.content;
                        if (content) {
                            days.value = content.days;
                            startDate.value = content.startDate;
                            if (content.endDate) endDate.value = content.endDate; else calculateEndDateFromDays();
                            if (content.tripTitle) tripTitle.value = content.tripTitle;
                            if (content.xuanList) xuanList.value = content.xuanList;
                            if (content.chiauList) chiauList.value = content.chiauList;
                            if (content.arrivalFlight) arrivalFlight.value = content.arrivalFlight;
                            if (content.departureFlight) departureFlight.value = content.departureFlight;
                            fetchWeather();
                            if (viewMode.value === 'map') renderMapMarkers();
                        }
                    }).subscribe();
            };

            const saveToCloud = async (forceReset = false) => {
                const isReset = forceReset === true;
                if (!supabase) return;
                const dataToSave = isReset ? defaultData : { 
                    tripTitle: tripTitle.value, startDate: startDate.value, endDate: endDate.value, 
                    days: days.value, xuanList: xuanList.value, chiauList: chiauList.value,
                    arrivalFlight: arrivalFlight.value, departureFlight: departureFlight.value
                };
                if (isReset) {
                    // Reset all refs
                    days.value = defaultData.days; startDate.value = defaultData.startDate; endDate.value = defaultData.endDate;
                    tripTitle.value = defaultData.tripTitle; xuanList.value = defaultData.xuanList; chiauList.value = defaultData.chiauList;
                    arrivalFlight.value = { code: '' }; departureFlight.value = { code: '' };
                }
                const { error } = await supabase.from('trip_plans').upsert({ id: TRIP_ID, content: dataToSave });
                if (error) console.error("Save Error:", error);
            };

            // --- Weather & Other Helpers ---
            const fetchWeather = async () => {
                const lat = 35.1815, lon = 136.9066;
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weathercode&daily=temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo&forecast_days=16`;
                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error('Weather API error');
                    weatherData.value = await response.json();
                } catch (e) { console.error("Weather error", e); }
            };

            const getDayDateString = (dayIdx, short = false) => {
                const date = new Date(startDate.value);
                date.setDate(date.getDate() + dayIdx);
                const mm = date.getMonth() + 1, dd = date.getDate();
                const dayName = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][date.getDay()];
                return short ? `${mm}/${dd} ${dayName}` : `${mm}/${dd}`;
            };

            const getEventWeather = (timeStr) => {
                if (!weatherData.value || !startDate.value) return null;
                const eventDate = new Date(startDate.value);
                eventDate.setDate(eventDate.getDate() + currentDayIndex.value);
                const hour = timeStr.split(':')[0].padStart(2, '0');
                const targetKey = `${eventDate.toISOString().split('T')[0]}T${hour}:00`;
                if (weatherData.value.hourly?.time) {
                     const index = weatherData.value.hourly.time.findIndex(t => t === targetKey);
                    if (index !== -1) return { temp: Math.round(weatherData.value.hourly.temperature_2m[index]), code: weatherData.value.hourly.weathercode[index] };
                }
                return null;
            };

            const currentDayWeatherSummary = computed(() => {
                if (!weatherData.value || !startDate.value || !weatherData.value.daily) return null;
                const dateStr = new Date(new Date(startDate.value).setDate(new Date(startDate.value).getDate() + currentDayIndex.value)).toISOString().split('T')[0];
                if (weatherData.value.daily.time) {
                    const index = weatherData.value.daily.time.findIndex(t => t === dateStr);
                    if (index !== -1) return { max: Math.round(weatherData.value.daily.temperature_2m_max[index]), min: Math.round(weatherData.value.daily.temperature_2m_min[index]) };
                }
                return null;
            });

            const getWeatherIcon = (code) => {
                const map = { 0: 'fa-sun', 1: 'fa-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud', 45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-rain', 61: 'fa-umbrella', 63: 'fa-umbrella', 65: 'fa-umbrella', 80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy', 95: 'fa-bolt' };
                return `fa-solid ${map[code] || 'fa-cloud'}`;
            };

            const getTypeColor = (type, mode) => {
                const colors = { sightseeing: { dot: 'bg-lake-400', text: 'text-lake-500' }, food: { dot: 'bg-orange-300', text: 'text-orange-400' }, shopping: { dot: 'bg-pink-300', text: 'text-pink-400' }, transport: { dot: 'bg-stone-300', text: 'text-stone-400' }, hotel: { dot: 'bg-indigo-300', text: 'text-indigo-400' } };
                return (colors[type] || colors['sightseeing'])[mode];
            };
            
            const getTypeName = (type) => ({ sightseeing: '景點', food: '美食', shopping: '購物', transport: '交通', hotel: '住宿' }[type] || '其他');
            const getMapUrl = (loc) => loc ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc)}` : '#';

            // --- CRUD ---
            const manualAddDay = () => { days.value.push({ date: `Day ${days.value.length + 1}`, events: [] }); currentDayIndex.value = days.value.length - 1; calculateEndDateFromDays(); saveToCloud(); setTimeout(() => scrollToDay(days.value.length - 1), 100); };
            const openAddModal = () => { 
                isFlightMode.value = false;
                isEditing.value = false; 
                form.value = { id: Date.now(), time: '09:00', type: 'sightseeing', title: '', location: '', note: '', lat: null, lng: null }; 
                showModal.value = true; 
            };
            const editEvent = (event) => { 
                isFlightMode.value = false;
                isEditing.value = true; 
                form.value = { ...event }; 
                showModal.value = true; 
            };
            const closeModal = () => showModal.value = false;
            
            const saveEvent = () => {
                const currentEvents = days.value[currentDayIndex.value].events;
                if (isEditing.value) {
                    const index = currentEvents.findIndex(e => e.id === form.value.id);
                    if (index !== -1) {
                        if (currentEvents[index].location !== form.value.location) { form.value.lat = null; form.value.lng = null; }
                        currentEvents[index] = { ...form.value };
                    }
                } else currentEvents.push({ ...form.value });
                saveToCloud(); closeModal();
            };

            const deleteEvent = () => {
                if (confirm('確定要刪除這個行程嗎？')) {
                    const currentEvents = days.value[currentDayIndex.value].events;
                    const index = currentEvents.findIndex(e => e.id === form.value.id);
                    if (index !== -1) currentEvents.splice(index, 1);
                    saveToCloud(); closeModal();
                }
            };

            const resetData = () => { if(confirm('確定要重置所有資料嗎？')) { saveToCloud(true); currentDayIndex.value = 0; viewMode.value = 'list'; } };

            onMounted(() => { initSupabase(); fetchWeather(); });

            return {
                days, currentDayIndex, showModal, isEditing, form, startDate, endDate, handleDateChange, manualAddDay, tripTitle,
                weatherData, status, viewMode, isScrolled, isMapLoading, currentTab, tabs, xuanList, chiauList, newItemXuan, newItemChiau,
                arrivalFlight, departureFlight, flightForm, openFlightModal, saveFlight, clearFlightData, isFlightMode, editingFlightType,
                currentDayEvents: computed(() => (days.value[currentDayIndex.value]?.events || [])),
                sortedEvents: computed(() => [...(days.value[currentDayIndex.value]?.events || [])].sort((a, b) => a.time.localeCompare(b.time))),
                getTypeColor, getTypeName, getMapUrl, getWeatherIcon, openAddModal, editEvent, closeModal, saveEvent, deleteEvent, resetData, scrollToDay, saveToCloud, changeDay, getDayDateString, getEventWeather, currentDayWeatherSummary, toggleViewMode, checkScroll, addShoppingItem, deleteShoppingItem
            };
        }
    }).mount('#app');
</script>
