<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 設定 Web App 模式，隱藏瀏覽器介面 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fafaf9">
    
    <title>NagoyaGo - 日系極簡版</title>
    
    <!-- Apple Touch Icon (iPhone 主畫面圖示) -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/zxuan-c/tour_app/refs/heads/main/icon.jpg">
    <link rel="icon" href="https://raw.githubusercontent.com/zxuan-c/tour_app/refs/heads/main/icon.jpg">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet CSS & JS (For Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5; 
            -webkit-tap-highlight-color: transparent;
        }
        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #FAFAF9; /* Stone-50 */
            min-height: 100vh;
            min-height: 100dvh; /* Better mobile support */
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
        }

        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }

        .slide-right-enter-active, .slide-right-leave-active { transition: all 0.3s ease; }
        .slide-right-enter-from { opacity: 0; transform: translateX(20px); }
        .slide-right-leave-to { opacity: 0; transform: translateX(-20px); }
        
        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(45, 212, 191, 0.1);
            border-radius: 50%;
            border-top: 2px solid #2dd4bf;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scroll Snap for Date Tabs */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }

        /* Map Container */
        #map-container {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        /* Checkbox Animation */
        .checkbox-wrapper input:checked + div {
            background-color: #2dd4bf;
            border-color: #2dd4bf;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        
        /* Flight Card Gradient */
        .flight-card-bg {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lake: {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a',
                        },
                        sumi: '#44403c',
                        washi: '#fafaf9',
                        sand: '#f5f5f4',
                    },
                    borderRadius: { '4xl': '2rem' }
                }
            }
        }
    </script>
</head>
<body class="text-stone-600 bg-gray-100">

<div id="app">
    <div class="app-container h-[100dvh]">
        
        <!-- Header Section -->
        <header class="bg-washi/95 backdrop-blur-md px-6 pt-6 pb-2 z-20 sticky top-0 border-b border-stone-100 transition-all duration-300" :class="{'shadow-sm': isScrolled}">
            <!-- Top Bar -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1 mr-4">
                    <div class="flex items-center gap-2 mb-1">
                        <!-- Editable Title Input -->
                        <input 
                            v-model="tripTitle" 
                            @blur="saveToCloud()"
                            @keydown.enter="$event.target.blur()"
                            type="text"
                            class="text-2xl font-bold text-sumi tracking-wider bg-transparent border-none outline-none w-full p-0 placeholder-stone-300 focus:ring-0"
                            placeholder="輸入行程名稱..."
                        >
                        <!-- Sync Indicator -->
                        <div class="flex-shrink-0 mt-1">
                            <span v-if="status === 'loading'" class="spinner"></span>
                            <span v-else-if="status === 'connected'" class="flex h-2 w-2 relative" title="已連線">
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-lake-300"></span>
                            </span>
                            <span v-else class="h-2 w-2 rounded-full bg-red-300" title="未連線"></span>
                        </div>
                    </div>
                    <p class="text-xs text-stone-400 font-normal mt-0.5 tracking-widest uppercase">JAPAN TRAVEL PLANNER</p>
                </div>
                
                <!-- Action Buttons (Only show in Itinerary mode) -->
                <div class="flex gap-2" v-if="currentTab === 'itinerary'">
                    <button @click="toggleViewMode" class="w-20 h-8 rounded-full bg-white border border-stone-100 text-stone-400 hover:text-lake-500 hover:border-lake-200 flex items-center justify-center transition-all shadow-sm gap-1 text-xs font-bold">
                        <i class="fa-solid" :class="viewMode === 'list' ? 'fa-map' : 'fa-list-ul'"></i>
                        <span>{{ viewMode === 'list' ? 'Map' : 'List' }}</span>
                    </button>
                    <button @click="confirmAction('reset')" class="w-8 h-8 rounded-full bg-white border border-stone-100 text-stone-300 hover:text-red-400 hover:border-red-100 flex items-center justify-center transition-colors shadow-sm">
                        <i class="fa-solid fa-rotate-right text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Date Range (Minimalist) -->
            <div class="flex items-center justify-between bg-white rounded-2xl p-1 pr-4 pl-4 mb-3 shadow-[0_2px_10px_rgba(0,0,0,0.02)] border border-stone-50">
                <div class="flex flex-col">
                    <span class="text-[10px] text-lake-400 font-bold tracking-widest uppercase">Departure</span>
                    <input type="date" v-model="startDate" @change="handleDateChange" class="text-sm font-bold text-sumi bg-transparent border-none outline-none p-0 w-28 font-mono">
                </div>
                <div class="w-px h-6 bg-stone-100 mx-2"></div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-stone-300 font-bold tracking-widest uppercase">Return</span>
                    <input type="date" v-model="endDate" @change="handleDateChange" class="text-sm font-bold text-stone-400 bg-transparent border-none outline-none p-0 w-28 text-right font-mono">
                </div>
            </div>

            <!-- Main Tab Navigation -->
            <div class="flex bg-stone-100 p-1 rounded-xl mb-3">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click="currentTab = tab.id"
                    class="flex-1 py-2 text-xs font-bold rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5"
                    :class="currentTab === tab.id ? 'bg-white text-sumi shadow-sm' : 'text-stone-400 hover:text-stone-500'"
                >
                    <i :class="tab.icon"></i>
                    {{ tab.label }}
                </button>
            </div>

            <!-- Day Selector (Only visible in Itinerary tab) -->
            <div v-if="currentTab === 'itinerary'" class="relative -mx-6 transition-all duration-300"> 
                <div class="flex overflow-x-auto no-scrollbar snap-x-mandatory px-6 pb-2 gap-4" id="day-scroller">
                    <button 
                        v-for="(day, index) in days" 
                        :key="index"
                        @click="changeDay(index)"
                        class="snap-center flex-shrink-0 relative py-2 transition-all duration-300 group"
                    >
                        <div 
                            class="px-5 py-2 rounded-2xl text-sm transition-all duration-300 flex flex-col items-center min-w-[70px]"
                            :class="currentDayIndex === index ? 'bg-lake-400 text-white shadow-lg shadow-lake-200 scale-100' : 'bg-white text-stone-400 border border-stone-100 group-hover:border-lake-200'"
                        >
                            <span class="font-bold tracking-wide">Day {{ index + 1 }}</span>
                            <span class="text-[10px] font-normal mt-0.5 opacity-90">{{ getDayDateString(index, true) }}</span>
                        </div>
                    </button>
                    
                    <button @click="manualAddDay" class="snap-center flex-shrink-0 px-4 py-2 flex items-center justify-center">
                        <div class="w-10 h-10 rounded-full bg-white border border-dashed border-lake-300 text-lake-400 flex items-center justify-center hover:bg-lake-50 transition-colors">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                    </button>
                    <div class="w-2 flex-shrink-0"></div>
                </div>
                <div class="absolute right-0 top-0 bottom-2 w-8 bg-gradient-to-l from-washi to-transparent pointer-events-none"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-hidden relative bg-washi">
            
            <!-- ====== ITINERARY TAB ====== -->
            <div v-if="currentTab === 'itinerary'" class="h-full relative">
                <!-- LIST VIEW (Added no-scrollbar) -->
                <div v-show="viewMode === 'list'" class="absolute inset-0 overflow-y-auto p-4 pb-24 no-scrollbar" @scroll="checkScroll">
                    
                    <!-- NEW: TODAY'S WEATHER WIDGET -->
                    <div class="mb-4 bg-white/60 backdrop-blur-sm border border-stone-100 rounded-2xl p-3 flex items-center justify-between shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-lake-50 text-lake-400 flex items-center justify-center">
                                <i :class="getWeatherIcon(todayWeatherSummary?.code)" class="text-xl"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest leading-none mb-1">Today's Nagoya</p>
                                <p class="text-sm font-bold text-sumi" v-if="todayWeatherSummary">
                                    {{ todayWeatherSummary.max }}° <span class="text-stone-300 font-normal">/</span> {{ todayWeatherSummary.min }}°
                                </p>
                                <p class="text-xs text-stone-300" v-else>Loading weather...</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] bg-lake-100 text-lake-600 px-2 py-0.5 rounded-full font-bold uppercase tracking-tighter">Current</span>
                        </div>
                    </div>

                    <!-- ARRIVAL FLIGHT CARD (Only Day 1) -->
                    <div v-if="currentDayIndex === 0" class="mb-6">
                        <div class="relative pl-10">
                            <div class="absolute left-0 top-6 w-10 h-10 flex items-center justify-center z-10">
                                <div class="w-8 h-8 rounded-full bg-lake-100 text-lake-500 flex items-center justify-center ring-4 ring-washi shadow-sm">
                                    <i class="fa-solid fa-plane-arrival text-xs"></i>
                                </div>
                            </div>
                            <div v-if="!arrivalFlight.code" class="bg-white p-5 rounded-[24px] shadow-[0_2px_15px_rgba(0,0,0,0.02)] border border-stone-50 border-dashed border-lake-200 flex items-center justify-center">
                                <button @click="openFlightModal('arrival')" class="flex items-center gap-2 text-lake-400 font-bold bg-lake-50 px-6 py-3 rounded-xl hover:bg-lake-100 transition-colors">
                                    <i class="fa-solid fa-plus"></i>
                                    設定去程航班資訊 (Manual)
                                </button>
                            </div>
                            <div v-else class="flight-card-bg p-5 rounded-[24px] shadow-md border border-white relative overflow-hidden group">
                                <div class="flex justify-between items-start relative z-10">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="bg-lake-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">Arrival</span>
                                            <span class="text-lake-600 font-bold text-lg font-mono">{{ arrivalFlight.code }}</span>
                                        </div>
                                        <h3 class="text-sumi font-bold text-sm mb-0.5">{{ arrivalFlight.title }}</h3>
                                        <p class="text-xs text-stone-400">{{ arrivalFlight.location }}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-sumi font-mono tracking-tight">{{ arrivalFlight.time }}</div>
                                        <div class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Estimated</div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-lake-100 flex items-center justify-between text-xs text-stone-500 relative z-10">
                                    <span class="flex items-center gap-1.5"><i class="fa-regular fa-clock text-lake-400"></i> {{ arrivalFlight.note }}</span>
                                    <button @click="openFlightModal('arrival')" class="text-stone-300 hover:text-lake-500 transition-colors px-2 py-1"><i class="fa-solid fa-pen"></i></button>
                                </div>
                                <i class="fa-solid fa-plane absolute -bottom-4 -right-4 text-[100px] text-lake-50 opacity-50 transform -rotate-45 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div v-if="currentDayEvents.length === 0" class="flex flex-col items-center justify-center py-20 text-stone-300">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-[0_4px_20px_rgba(0,0,0,0.03)] mb-4 animate-pulse">
                            <i class="fa-regular fa-map text-2xl text-lake-200"></i>
                        </div>
                        <p class="font-normal tracking-widest text-sm">PLAN YOUR JOURNEY</p>
                    </div>

                    <!-- Timeline & Events -->
                    <div v-else class="space-y-6 relative">
                        <div class="absolute left-[19px] top-0 bottom-0 w-px bg-stone-200/60"></div>

                        <transition-group name="slide-right" tag="div" class="space-y-6">
                            <div v-for="event in sortedEvents" :key="event.id" class="relative pl-10 group">
                                <div class="absolute left-0 top-3 w-10 h-10 flex items-center justify-center z-10">
                                    <div class="w-2.5 h-2.5 rounded-full ring-4 ring-washi transition-colors duration-300" :class="getTypeColor(event.type, 'dot')"></div>
                                </div>
                                <div 
                                    class="bg-white shadow-lg border border-stone-50 active:scale-[0.98] transition-all duration-200 relative overflow-hidden hover:shadow-xl rounded-[24px] flex flex-col"
                                    @click="editEvent(event)"
                                >
                                    <div class="py-2 px-4 rounded-t-[24px] flex justify-between items-center text-white" :class="getTypeColor(event.type, 'header')">
                                        <span class="text-lg font-bold font-mono tracking-tight">
                                            {{ event.time }}<span v-if="event.endTime"> - {{ event.endTime }}</span>
                                        </span>
                                        <span class="text-xs font-bold tracking-widest">{{ getTypeName(event.type) }}</span>
                                    </div>
                                    
                                    <div class="flex-1 p-5 pt-4 flex flex-col justify-start"> 
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="text-xl font-bold text-sumi leading-snug flex-shrink-0 mr-4 max-w-[70%]">
                                                {{ event.title }}
                                            </h3>
                                            <span v-if="event.endTime" class="text-sm font-medium text-stone-400 whitespace-nowrap pt-1">
                                                {{ formatDuration(event.time, event.endTime) }}
                                            </span>
                                        </div>
                                        <div class="flex items-center justify-between text-stone-400 text-xs font-normal mt-1 mb-2">
                                            <div class="flex items-center max-w-[80%]">
                                                <i class="fa-solid fa-location-dot mr-1.5 opacity-50 flex-shrink-0"></i>
                                                <span class="truncate">{{ event.location }}</span>
                                            </div>
                                            <a :href="getMapUrl(event.location)" target="_blank" @click.stop class="w-8 h-8 flex items-center justify-center rounded-full bg-stone-50 text-stone-300 hover:bg-lake-50 hover:text-lake-400 transition-colors flex-shrink-0">
                                                <i class="fa-solid fa-location-arrow text-xs"></i>
                                            </a>
                                        </div>
                                        <p v-if="event.note" class="text-stone-400 text-xs mt-3 pt-3 border-t border-stone-50/80 leading-relaxed font-normal">
                                            {{ event.note }}
                                        </p>
                                    </div>

                                    <div v-if="getEventWeather(event.time)" class="absolute bottom-4 right-4 flex items-center text-xs text-lake-400 bg-lake-50/50 px-2 py-1 rounded-lg backdrop-blur-sm pointer-events-none">
                                        <i :class="getWeatherIcon(getEventWeather(event.time).code)" class="mr-1.5"></i>
                                        <span>{{ getEventWeather(event.time).temp }}°</span>
                                    </div>
                                </div>
                            </div>
                        </transition-group>
                    </div>

                    <!-- DEPARTURE FLIGHT CARD (Only Last Day) -->
                    <div v-if="currentDayIndex === days.length - 1" class="mt-6">
                        <div class="relative pl-10">
                            <div class="absolute left-0 top-6 w-10 h-10 flex items-center justify-center z-10">
                                <div class="w-8 h-8 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center ring-4 ring-washi shadow-sm">
                                    <i class="fa-solid fa-plane-departure text-xs"></i>
                                </div>
                            </div>
                            <div v-if="!departureFlight.code" class="bg-white p-5 rounded-[24px] shadow-[0_2px_15px_rgba(0,0,0,0.02)] border border-stone-50 border-dashed border-stone-200 flex items-center justify-center">
                                <button @click="openFlightModal('departure')" class="flex items-center gap-2 text-stone-400 font-bold bg-stone-50 px-6 py-3 rounded-xl hover:bg-stone-100 transition-colors">
                                    <i class="fa-solid fa-plus"></i>
                                    設定回程航班資訊 (Manual)
                                </button>
                            </div>
                            <div v-else class="flight-card-bg p-5 rounded-[24px] shadow-md border border-white relative overflow-hidden group">
                                <div class="flex justify-between items-start relative z-10">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="bg-stone-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">Return</span>
                                            <span class="text-stone-600 font-bold text-lg font-mono">{{ departureFlight.code }}</span>
                                        </div>
                                        <h3 class="text-sumi font-bold text-sm mb-0.5">{{ departureFlight.title }}</h3>
                                        <p class="text-xs text-stone-400">{{ departureFlight.location }}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-sumi font-mono tracking-tight">{{ departureFlight.time }}</div>
                                        <div class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Departure</div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-lake-100 flex items-center justify-between text-xs text-stone-500 relative z-10">
                                    <span class="flex items-center gap-1.5"><i class="fa-regular fa-clock text-stone-400"></i> {{ departureFlight.note }}</span>
                                    <button @click="openFlightModal('departure')" class="text-stone-300 hover:text-stone-500 transition-colors px-2 py-1"><i class="fa-solid fa-pen"></i></button>
                                </div>
                                <i class="fa-solid fa-plane-departure absolute -bottom-4 -right-4 text-[100px] text-stone-100 opacity-50 transform -rotate-12 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MAP VIEW -->
                <div v-show="viewMode === 'map'" class="absolute inset-0 bg-stone-100">
                    <div id="map-container"></div>
                    <div v-if="isMapLoading" class="absolute top-4 right-4 bg-white/90 backdrop-blur px-3 py-2 rounded-xl shadow-lg z-[1000] flex items-center gap-2 text-xs font-bold text-lake-500">
                        <div class="spinner w-3 h-3 border-t-lake-500"></div>
                        <span>Locating...</span>
                    </div>
                    <div v-if="currentDayEvents.length === 0" class="absolute inset-0 flex items-center justify-center pointer-events-none z-[1000]">
                        <div class="bg-white/80 backdrop-blur px-6 py-4 rounded-2xl shadow-xl text-center">
                            <p class="text-stone-500 font-bold">No locations yet</p>
                            <p class="text-xs text-stone-400">Switch to list to add events</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ====== SHOPPING LISTS (XUAN & CHIAU) ====== -->
            <template v-for="user in ['xuan', 'chiau']" :key="user">
                <div v-if="currentTab === user" class="absolute inset-0 overflow-y-auto p-4 pb-24 bg-washi no-scrollbar">
                    <div class="bg-white p-6 rounded-[32px] shadow-sm border border-stone-50 min-h-[400px]">
                        <h2 class="text-xl font-bold text-sumi mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm" :class="user === 'xuan' ? 'bg-pink-100 text-pink-500' : 'bg-indigo-100 text-indigo-500'">
                                <i class="fa-solid" :class="user === 'xuan' ? 'fa-bag-shopping' : 'fa-cart-shopping'"></i>
                            </span>
                            {{ user === 'xuan' ? 'Xuan' : 'Chiau' }} 的購物清單
                        </h2>
                        
                        <div class="space-y-2 mb-6">
                            <input v-model="newItemText[user]" @keydown.enter="addShoppingItem(user)" type="text" placeholder="想買什麼？" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 transition-all outline-none" :class="user === 'xuan' ? 'focus:ring-pink-200' : 'focus:ring-indigo-200'">
                            <div class="flex gap-2">
                                <input v-model="newItemCategory[user]" @keydown.enter="addShoppingItem(user)" type="text" placeholder="分類 (例如：藥妝)" class="flex-1 bg-stone-50 border-none rounded-xl px-4 py-3 text-sm focus:ring-2 transition-all outline-none" :class="user === 'xuan' ? 'focus:ring-pink-200' : 'focus:ring-indigo-200'">
                                <button @click="addShoppingItem(user)" class="w-12 h-11 rounded-xl text-white shadow-lg transition-colors flex items-center justify-center" :class="user === 'xuan' ? 'bg-pink-400 shadow-pink-200 hover:bg-pink-500' : 'bg-indigo-400 shadow-indigo-200 hover:bg-indigo-500'">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Grouped List -->
                        <div class="space-y-8">
                            <div v-for="(group, catName) in groupedShoppingList(user)" :key="catName" class="space-y-3">
                                <h3 class="text-xs font-bold text-stone-300 uppercase tracking-widest flex items-center gap-2">
                                    <span class="w-1.5 h-1.5 rounded-full" :class="user === 'xuan' ? 'bg-pink-400' : 'bg-indigo-400'"></span>
                                    {{ catName || '未分類' }}
                                </h3>
                                <div v-for="item in group" :key="item.id" class="flex items-center gap-3 p-3 rounded-xl bg-stone-50 group hover:bg-white hover:shadow-sm border border-transparent hover:border-stone-100 transition-all">
                                    <label class="checkbox-wrapper cursor-pointer relative w-6 h-6">
                                        <input type="checkbox" v-model="item.checked" @change="saveToCloud()" class="opacity-0 absolute w-full h-full cursor-pointer">
                                        <div class="w-6 h-6 border-2 border-stone-300 rounded-lg flex items-center justify-center transition-all bg-white">
                                            <svg class="w-3 h-3 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                    </label>
                                    <span class="flex-1 text-sm font-medium transition-all" :class="item.checked ? 'text-stone-300 line-through' : 'text-sumi'">{{ item.text }}</span>
                                    <button @click="confirmAction('deleteItem', {who: user, id: item.id})" class="text-stone-300 hover:text-red-400 p-2 rounded-full hover:bg-red-50 transition-colors opacity-0 group-hover:opacity-100">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="(user === 'xuan' ? xuanList : chiauList).length === 0" class="text-center py-10 text-stone-300 text-xs tracking-widest">
                                EMPTY LIST
                            </div>
                        </div>
                    </div>
                </div>
            </template>

        </main>

        <!-- FAB (Floating Action Button) -->
        <transition name="fade">
            <button 
                v-if="currentTab === 'itinerary' && viewMode === 'list'"
                @click="openAddModal" 
                class="absolute bottom-8 right-6 w-14 h-14 bg-lake-400 text-white rounded-[20px] shadow-xl shadow-lake-300/40 flex items-center justify-center text-xl hover:bg-lake-500 hover:scale-105 active:scale-95 transition-all z-30"
            >
                <i class="fa-solid fa-plus"></i>
            </button>
        </transition>

        <!-- CONFIRMATION MODAL -->
        <transition name="fade">
            <div v-if="confirmState.show" class="absolute inset-0 z-[60] flex items-center justify-center bg-stone-900/30 backdrop-blur-sm p-6">
                <div class="bg-white rounded-2xl p-6 shadow-2xl w-full max-w-xs text-center transform transition-all scale-100">
                    <div class="w-12 h-12 rounded-full bg-red-100 text-red-500 flex items-center justify-center mx-auto mb-4 text-xl">
                        <i class="fa-solid fa-exclamation"></i>
                    </div>
                    <h3 class="text-lg font-bold text-sumi mb-2">確定執行？</h3>
                    <p class="text-sm text-stone-400 mb-6">{{ confirmState.message }}</p>
                    <div class="flex gap-3">
                        <button @click="confirmState.show = false" class="flex-1 py-2.5 rounded-xl border border-stone-200 text-stone-400 font-medium hover:bg-stone-50 transition-colors">取消</button>
                        <button @click="executeConfirm" class="flex-1 py-2.5 rounded-xl bg-red-400 text-white font-bold shadow-lg shadow-red-200 hover:bg-red-500 transition-colors">確認刪除</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Edit/Add Event Modal -->
        <transition name="slide-up">
            <div v-if="showModal && !isFlightMode" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div @click="closeModal" class="absolute inset-0 bg-stone-900/20 backdrop-blur-sm pointer-events-auto transition-opacity"></div>
                <div class="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-8 pointer-events-auto shadow-2xl relative max-h-[90vh] overflow-y-auto no-scrollbar">
                    <div class="w-12 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-xl font-bold text-sumi tracking-wide">{{ isEditing ? '編輯行程' : '新增行程' }}</h2>
                        <button @click="closeModal" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 flex items-center justify-center hover:bg-stone-100 transition-colors flex-shrink-0">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>

                    <form @submit.prevent="saveEvent" class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">開始時間</label>
                                <div class="flex gap-2">
                                    <select v-model="form.hour" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm focus:ring-2 focus:ring-lake-200 appearance-none text-center">
                                        <option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option>
                                    </select>
                                    <span class="py-3 text-stone-300">:</span>
                                    <select v-model="form.minute" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm focus:ring-2 focus:ring-lake-200 appearance-none text-center">
                                        <option v-for="m in 12" :key="m-1" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-span-3">
                                <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">類別</label>
                                <select v-model="form.type" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm appearance-none focus:ring-2 focus:ring-lake-200 transition-shadow">
                                    <option value="sightseeing">景點 Sightseeing</option>
                                    <option value="food">美食 Food</option>
                                    <option value="shopping">購物 Shopping</option>
                                    <option value="transport">交通 Transport</option>
                                    <option value="hotel">住宿 Hotel</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">結束時間</label>
                                <div class="flex gap-2">
                                    <select v-model="form.endHour" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm focus:ring-2 focus:ring-lake-200 appearance-none text-center">
                                        <option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option>
                                    </select>
                                    <span class="py-3 text-stone-300">:</span>
                                    <select v-model="form.endMinute" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm focus:ring-2 focus:ring-lake-200 appearance-none text-center">
                                        <option v-for="m in 12" :key="m-1" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">標題</label>
                            <input v-model="form.title" type="text" placeholder="要去哪裡呢？" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow">
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">地點</label>
                            <div class="relative">
                                <input v-model="form.location" type="text" placeholder="輸入地點..." class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 pl-10 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow">
                                <i class="fa-solid fa-map-pin absolute left-4 top-3.5 text-stone-300 text-sm"></i>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">備註</label>
                            <textarea v-model="form.note" rows="3" placeholder="補充資訊..." class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm placeholder-stone-300 focus:ring-2 focus:ring-lake-200 transition-shadow resize-none"></textarea>
                        </div>

                        <div class="pt-6 flex gap-3">
                            <button v-if="isEditing" type="button" @click="confirmAction('deleteEvent')" class="w-12 h-12 rounded-xl bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition-colors">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                            <button type="submit" class="flex-1 bg-lake-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-lake-200 hover:bg-lake-500 transition-all">
                                {{ isEditing ? '儲存變更' : '加入行程' }}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

        <!-- Edit/Add FLIGHT Modal -->
        <transition name="slide-up">
            <div v-if="showModal && isFlightMode" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div @click="closeModal" class="absolute inset-0 bg-stone-900/20 backdrop-blur-sm pointer-events-auto transition-opacity"></div>
                <div class="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-8 pointer-events-auto shadow-2xl relative max-h-[90vh] overflow-y-auto no-scrollbar">
                    <div class="w-12 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-xl font-bold text-sumi tracking-wide">{{ editingFlightType === 'arrival' ? '去程航班' : '回程航班' }}</h2>
                        <button @click="closeModal" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 flex items-center justify-center hover:bg-stone-100 transition-colors flex-shrink-0">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <form @submit.prevent="saveFlight" class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">航班代號</label>
                            <input v-model="flightForm.code" type="text" placeholder="e.g. JX838" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm uppercase font-mono">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">航空公司 / 標題</label>
                            <input v-model="flightForm.title" type="text" placeholder="e.g. 星宇航空" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">起降時間</label>
                            <input v-model="flightForm.time" type="text" placeholder="e.g. 14:55 - 18:30" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">機場 / 地點</label>
                            <input v-model="flightForm.location" type="text" placeholder="e.g. NGO" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">備註 / 航廈</label>
                            <textarea v-model="flightForm.note" rows="2" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm resize-none"></textarea>
                        </div>
                        <div class="pt-6 flex gap-3">
                            <button type="button" @click="confirmAction('clearFlight')" class="w-12 h-12 rounded-xl bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition-colors">
                                <i class="fa-regular fa-trash-can"></i>
                            </button>
                            <button type="submit" class="flex-1 bg-lake-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-lake-200 hover:bg-lake-500 transition-all">儲存航班資訊</button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- Supabase Config ---
            const SUPABASE_URL = 'https://nrormwhklkytqyrbrdbr.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_QuvW2VoIHavfZ7RunbOl1A_Fu34ri_D';

            // --- State ---
            const days = ref([]);
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const isEditing = ref(false);
            const isFlightMode = ref(false); 
            const editingFlightType = ref(''); 
            const tripTitle = ref('Nagoya.Go');
            const confirmState = ref({ show: false, message: '', type: '', payload: null });

            const arrivalFlight = ref({ code: '', time: '', title: '', location: '', note: '', lat: null, lng: null });
            const departureFlight = ref({ code: '', time: '', title: '', location: '', note: '', lat: null, lng: null });
            const flightForm = ref({ code: '', time: '', title: '', location: '', note: '' });

            const currentTab = ref('itinerary'); 
            const tabs = [
                { id: 'itinerary', label: '行程', icon: 'fa-solid fa-calendar-days' },
                { id: 'xuan', label: 'Xuan', icon: 'fa-solid fa-user' },
                { id: 'chiau', label: 'Chiau', icon: 'fa-solid fa-user' },
            ];

            const xuanList = ref([]);
            const chiauList = ref([]);
            const newItemText = ref({ xuan: '', chiau: '' });
            const newItemCategory = ref({ xuan: '', chiau: '' });
            
            const viewMode = ref('list'); 
            const isScrolled = ref(false);
            const isMapLoading = ref(false);
            let map = null;
            let markers = [];

            const startDate = ref(new Date().toISOString().split('T')[0]); 
            const endDate = ref(''); 
            const weatherData = ref(null);
            const status = ref('disconnected'); 
            let supabase = null;
            const TRIP_ID = 'nagoya_main'; 

            const form = ref({ 
                id: null, time: '09:00', endTime: '10:00', hour: '09', minute: '00', endHour: '10', endMinute: '00',
                type: 'sightseeing', title: '', location: '', note: '', lat: null, lng: null 
            });

            const defaultStartDate = new Date().toISOString().split('T')[0];
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultEndDate = tomorrow.toISOString().split('T')[0];

            const defaultData = {
                tripTitle: 'Nagoya.Go', startDate: defaultStartDate, endDate: defaultEndDate,
                xuanList: [], chiauList: [], arrivalFlight: { code: '' }, departureFlight: { code: '' },
                days: [{ date: 'Day 1', events: [] }]
            };

            // --- Methods ---
            const confirmAction = (type, payload = null) => {
                confirmState.value = { show: true, type, payload, message: '' };
                if (type === 'deleteEvent') confirmState.value.message = '確定要刪除這個行程嗎？';
                else if (type === 'deleteItem') confirmState.value.message = '確定刪除此購物項目嗎？';
                else if (type === 'clearFlight') confirmState.value.message = '確定清除此航班資訊嗎？';
                else if (type === 'reset') confirmState.value.message = '確定要重置所有資料嗎？';
            };

            const executeConfirm = () => {
                const { type, payload } = confirmState.value;
                confirmState.value.show = false;
                if (type === 'deleteEvent') {
                    const currentEvents = days.value[currentDayIndex.value].events;
                    const index = currentEvents.findIndex(e => e.id === form.value.id);
                    if (index !== -1) currentEvents.splice(index, 1);
                    saveToCloud(); closeModal();
                } else if (type === 'deleteItem') {
                    const list = payload.who === 'xuan' ? xuanList : chiauList;
                    const idx = list.value.findIndex(i => i.id === payload.id);
                    if (idx !== -1) list.value.splice(idx, 1);
                    saveToCloud();
                } else if (type === 'clearFlight') {
                    const target = editingFlightType.value === 'arrival' ? arrivalFlight : departureFlight;
                    target.value = { code: '', time: '', title: '', location: '', note: '' };
                    saveToCloud(); closeModal();
                } else if (type === 'reset') {
                    saveToCloud(true); currentDayIndex.value = 0; viewMode.value = 'list';
                }
            };

            const addShoppingItem = (who) => {
                const text = newItemText.value[who].trim();
                const cat = newItemCategory.value[who].trim();
                if (!text) return;
                const item = { id: Date.now(), text, category: cat, checked: false };
                if (who === 'xuan') xuanList.value.push(item); else chiauList.value.push(item);
                newItemText.value[who] = '';
                newItemCategory.value[who] = '';
                saveToCloud();
            };

            const groupedShoppingList = (who) => {
                const list = who === 'xuan' ? xuanList.value : chiauList.value;
                return list.reduce((acc, item) => {
                    const cat = item.category || '';
                    if (!acc[cat]) acc[cat] = [];
                    acc[cat].push(item);
                    return acc;
                }, {});
            };

            // --- Weather ---
            const todayWeatherSummary = computed(() => {
                if (!weatherData.value || !weatherData.value.daily) return null;
                const todayStr = new Date().toISOString().split('T')[0];
                const index = weatherData.value.daily.time.findIndex(t => t === todayStr);
                // Fallback to first item if today is not found
                const targetIdx = index !== -1 ? index : 0;
                return {
                    max: Math.round(weatherData.value.daily.temperature_2m_max[targetIdx]),
                    min: Math.round(weatherData.value.daily.temperature_2m_min[targetIdx]),
                    code: weatherData.value.daily.weathercode?.[targetIdx] || 0
                };
            });

            const getEventWeather = (timeStr) => {
                if (!weatherData.value || !startDate.value) return null;
                const eventDate = new Date(startDate.value);
                eventDate.setDate(eventDate.getDate() + currentDayIndex.value);
                const hour = timeStr.split(':')[0].padStart(2, '0');
                const targetKey = `${eventDate.toISOString().split('T')[0]}T${hour}:00`;
                if (weatherData.value.hourly?.time) {
                     const index = weatherData.value.hourly.time.findIndex(t => t === targetKey);
                    if (index !== -1) return { temp: Math.round(weatherData.value.hourly.temperature_2m[index]), code: weatherData.value.hourly.weathercode[index] };
                }
                return null;
            };

            const getWeatherIcon = (code) => {
                const map = { 0: 'fa-sun', 1: 'fa-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud', 45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-rain', 61: 'fa-umbrella', 63: 'fa-umbrella', 65: 'fa-umbrella', 80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy', 95: 'fa-bolt' };
                return `fa-solid ${map[code] || 'fa-cloud'}`;
            };

            // --- Map Logic ---
            const toggleViewMode = () => {
                viewMode.value = viewMode.value === 'list' ? 'map' : 'list';
                if (viewMode.value === 'map') { nextTick(() => { initMap(); renderMapMarkers(); }); }
            };

            const initMap = () => {
                if (map) return; 
                map = L.map('map-container').setView([35.1709, 136.8815], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '&copy; CARTO', maxZoom: 19 }).addTo(map);
            };

            const renderMapMarkers = async () => {
                if (!map) return;
                markers.forEach(m => map.removeLayer(m));
                markers = [];
                const events = days.value[currentDayIndex.value]?.events || [];
                const bounds = L.latLngBounds();
                let hasPoints = false;
                for (const event of events) {
                    if (event.lat && event.lng) {
                        const m = L.marker([event.lat, event.lng]).addTo(map).bindPopup(event.title);
                        markers.push(m); bounds.extend([event.lat, event.lng]); hasPoints = true;
                    }
                }
                if (hasPoints) map.fitBounds(bounds, { padding: [50, 50], maxZoom: 15 });
            };

            // --- Supabase & Data ---
            const saveToCloud = async (forceReset = false) => {
                if (!supabase) return;
                status.value = 'loading';
                const dataToSave = forceReset ? defaultData : { 
                    tripTitle: tripTitle.value, startDate: startDate.value, endDate: endDate.value, 
                    days: days.value, xuanList: xuanList.value, chiauList: chiauList.value,
                    arrivalFlight: arrivalFlight.value, departureFlight: departureFlight.value
                };
                if(forceReset) { days.value = defaultData.days; xuanList.value = []; chiauList.value = []; }
                const { error } = await supabase.from('trip_plans').upsert({ id: TRIP_ID, content: dataToSave });
                status.value = error ? 'error' : 'connected';
            };

            const initSupabase = async () => {
                const { createClient } = window.supabase;
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data } = await supabase.from('trip_plans').select('content').eq('id', TRIP_ID).maybeSingle();
                if (data?.content) {
                    days.value = data.content.days; tripTitle.value = data.content.tripTitle;
                    startDate.value = data.content.startDate; endDate.value = data.content.endDate;
                    xuanList.value = data.content.xuanList || []; chiauList.value = data.content.chiauList || [];
                    arrivalFlight.value = data.content.arrivalFlight || { code: '' };
                    departureFlight.value = data.content.departureFlight || { code: '' };
                } else { days.value = defaultData.days; }
                status.value = 'connected';
            };

            // --- Lifecycle & Helpers ---
            const fetchWeather = async () => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.18&longitude=136.91&hourly=temperature_2m,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=Asia%2FTokyo&forecast_days=16`);
                    weatherData.value = await res.json();
                } catch(e) { console.error(e); }
            };

            const formatDuration = (s, e) => {
                if(!s || !e) return '';
                const [sh, sm] = s.split(':').map(Number), [eh, em] = e.split(':').map(Number);
                let diff = (eh * 60 + em) - (sh * 60 + sm);
                if(diff < 0) diff += 1440;
                const h = Math.floor(diff/60), m = diff%60;
                return `${h?h+'hr ':''}${m?m+'min':''}`;
            };

            const getTypeColor = (t, m) => {
                const c = { sightseeing: 'lake-400', food: 'orange-400', shopping: 'pink-400', transport: 'stone-400', hotel: 'indigo-400' };
                const key = c[t] || c.sightseeing;
                return m === 'dot' ? 'bg-' + key : (m === 'header' ? 'bg-' + key : 'text-' + key);
            };

            const getTypeName = (t) => ({ sightseeing: '景點', food: '美食', shopping: '購物', transport: '交通', hotel: '住宿' }[t] || '行程');
            const getDayDateString = (i, s) => {
                const d = new Date(startDate.value); d.setDate(d.getDate() + i);
                return `${d.getMonth()+1}/${d.getDate()}${s?' '+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]:''}`;
            };

            const changeDay = (i) => currentDayIndex.value = i;
            const openAddModal = () => { isFlightMode.value = false; isEditing.value = false; form.value = { id: Date.now(), time: '09:00', endTime: '10:00', hour: '09', minute: '00', endHour: '10', endMinute: '00', type: 'sightseeing', title: '', location: '', note: '' }; showModal.value = true; };
            const editEvent = (e) => { isFlightMode.value = false; isEditing.value = true; const [h, m] = e.time.split(':'), [eh, em] = e.endTime.split(':'); form.value = { ...e, hour: h, minute: m, endHour: eh, endMinute: em }; showModal.value = true; };
            const closeModal = () => showModal.value = false;
            const saveEvent = () => {
                form.value.time = `${form.value.hour}:${form.value.minute}`; form.value.endTime = `${form.value.endHour}:${form.value.endMinute}`;
                const evs = days.value[currentDayIndex.value].events;
                if(isEditing.value) { const idx = evs.findIndex(x => x.id === form.value.id); evs[idx] = { ...form.value }; } else { evs.push({ ...form.value }); }
                saveToCloud(); closeModal();
            };
            const openFlightModal = (t) => { isFlightMode.value = true; editingFlightType.value = t; flightForm.value = { ...(t === 'arrival' ? arrivalFlight.value : departureFlight.value) }; showModal.value = true; };
            const saveFlight = () => { if(editingFlightType.value === 'arrival') arrivalFlight.value = { ...flightForm.value }; else departureFlight.value = { ...flightForm.value }; saveToCloud(); closeModal(); };
            const manualAddDay = () => { days.value.push({ date: `Day ${days.value.length+1}`, events: [] }); saveToCloud(); };
            const getMapUrl = (l) => l ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}` : '#';
            const checkScroll = (e) => isScrolled.value = e.target.scrollTop > 10;
            const handleDateChange = () => { saveToCloud(); };

            onMounted(() => { initSupabase(); fetchWeather(); });

            return {
                days, currentDayIndex, showModal, isEditing, form, startDate, endDate, handleDateChange, manualAddDay, tripTitle,
                weatherData, status, viewMode, isScrolled, isMapLoading, currentTab, tabs, xuanList, chiauList, newItemText, newItemCategory,
                arrivalFlight, departureFlight, flightForm, openFlightModal, saveFlight, isFlightMode, editingFlightType,
                confirmState, confirmAction, executeConfirm,
                todayWeatherSummary, formatDuration, getTypeColor, getTypeName, getMapUrl, getWeatherIcon, openAddModal, editEvent, closeModal, saveEvent, saveToCloud, changeDay, getDayDateString, getEventWeather, toggleViewMode, checkScroll, addShoppingItem, groupedShoppingList,
                sortedEvents: computed(() => [...(days.value[currentDayIndex.value]?.events || [])].sort((a, b) => a.time.localeCompare(b.time))),
                currentDayEvents: computed(() => days.value[currentDayIndex.value]?.events || [])
            };
        }
    }).mount('#app');
</script>
