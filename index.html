<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- 設定 Web App 模式，隱藏瀏覽器介面 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#fafaf9">
    
    <title>NagoyaGo - 日系極簡版</title>
    
    <!-- Apple Touch Icon (iPhone 主畫面圖示) -->
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/zxuan-c/tour_app/refs/heads/main/icon.jpg">
    <link rel="icon" href="https://raw.githubusercontent.com/zxuan-c/tour_app/refs/heads/main/icon.jpg">
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Leaflet CSS & JS (For Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- Google Fonts: Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5; 
            -webkit-tap-highlight-color: transparent;
        }
        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            background-color: #FAFAF9; /* Stone-50 */
            min-height: 100vh;
            min-height: 100dvh; /* Better mobile support */
            position: relative;
            box-shadow: 0 0 40px rgba(0,0,0,0.03);
            display: flex;
            flex-direction: column;
        }

        /* Transitions */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); opacity: 0; }

        .slide-right-enter-active, .slide-right-leave-active { transition: all 0.3s ease; }
        .slide-right-enter-from { opacity: 0; transform: translateX(20px); }
        .slide-right-leave-to { opacity: 0; transform: translateX(-20px); }
        
        /* Loading Spinner */
        .spinner {
            border: 2px solid rgba(45, 212, 191, 0.1);
            border-radius: 50%;
            border-top: 2px solid #2dd4bf;
            width: 18px;
            height: 18px;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Scroll Snap for Date Tabs */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }

        /* Map Container */
        #map-container {
            height: 100%;
            width: 100%;
            z-index: 1;
        }
        /* Custom Leaflet Popup */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .leaflet-popup-content {
            margin: 12px;
            font-family: 'Noto Sans TC', sans-serif;
        }
        
        /* Checkbox Animation */
        .checkbox-wrapper input:checked + div {
            background-color: #2dd4bf;
            border-color: #2dd4bf;
        }
        .checkbox-wrapper input:checked + div svg {
            display: block;
        }
        
        /* Flight Card Gradient */
        .flight-card-bg {
            background: linear-gradient(135deg, #ffffff 0%, #f0f9ff 100%);
        }

        /* Long press scale effect */
        .shopping-item {
            transition: transform 0.2s ease, background-color 0.2s ease;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        .shopping-item:active {
            transform: scale(0.98);
            background-color: #f5f5f4;
        }
        
        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }
        .slide-up-animation {
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        lake: {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4', 400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 800: '#115e59', 900: '#134e4a',
                        },
                        sumi: '#44403c',
                        washi: '#fafaf9',
                        sand: '#f5f5f4',
                    },
                    borderRadius: { '4xl': '2rem' }
                }
            }
        }
    </script>
</head>
<body class="text-stone-600 bg-gray-100">

<div id="app">
    <div class="app-container h-[100dvh]">
        
        <!-- Header Section -->
        <header class="bg-washi/95 backdrop-blur-md px-6 pt-6 pb-2 z-20 sticky top-0 border-b border-stone-100 transition-all duration-300" :class="{'shadow-sm': isScrolled}">
            <!-- Top Bar -->
            <div class="flex justify-between items-start mb-4">
                <div class="flex-1 mr-4">
                    <div class="flex items-center gap-2 mb-1">
                        <!-- Editable Title Input -->
                        <input 
                            v-model="tripTitle" 
                            @blur="saveToCloud()"
                            @keydown.enter="$event.target.blur()"
                            type="text"
                            class="text-2xl font-bold text-sumi tracking-wider bg-transparent border-none outline-none w-full p-0 placeholder-stone-300 focus:ring-0"
                            placeholder="輸入行程名稱..."
                        >
                        <!-- Sync Indicator -->
                        <div class="flex-shrink-0 mt-1">
                            <span v-if="status === 'loading'" class="spinner"></span>
                            <span v-else-if="status === 'connected'" class="flex h-2 w-2 relative" title="已連線">
                                <span class="relative inline-flex rounded-full h-2 w-2 bg-lake-300"></span>
                            </span>
                            <span v-else class="h-2 w-2 rounded-full bg-red-300" title="未連線"></span>
                        </div>
                    </div>
                    <p class="text-xs text-stone-400 font-normal mt-0.5 tracking-widest uppercase">JAPAN TRAVEL PLANNER</p>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-2" v-if="currentTab === 'itinerary'">
                    <button @click="toggleViewMode" class="w-20 h-8 rounded-full bg-white border border-stone-100 text-stone-400 hover:text-lake-500 hover:border-lake-200 flex items-center justify-center transition-all shadow-sm gap-1 text-xs font-bold">
                        <i class="fa-solid" :class="viewMode === 'list' ? 'fa-map' : 'fa-list-ul'"></i>
                        <span>{{ viewMode === 'list' ? 'Map' : 'List' }}</span>
                    </button>
                    <button @click="confirmAction('reset')" class="w-8 h-8 rounded-full bg-white border border-stone-100 text-stone-300 hover:text-red-400 hover:border-red-100 flex items-center justify-center transition-colors shadow-sm">
                        <i class="fa-solid fa-rotate-right text-xs"></i>
                    </button>
                </div>
            </div>

            <!-- Date Range -->
            <div class="flex items-center justify-between bg-white rounded-2xl p-1 pr-4 pl-4 mb-3 shadow-[0_2px_10px_rgba(0,0,0,0.02)] border border-stone-50">
                <div class="flex flex-col">
                    <span class="text-[10px] text-lake-400 font-bold tracking-widest uppercase">Departure</span>
                    <input type="date" v-model="startDate" @change="handleDateChange" class="text-sm font-bold text-sumi bg-transparent border-none outline-none p-0 w-28 font-mono">
                </div>
                <div class="w-px h-6 bg-stone-100 mx-2"></div>
                <div class="flex flex-col items-end">
                    <span class="text-[10px] text-stone-300 font-bold tracking-widest uppercase">Return</span>
                    <input type="date" v-model="endDate" @change="handleDateChange" class="text-sm font-bold text-stone-400 bg-transparent border-none outline-none p-0 w-28 text-right font-mono">
                </div>
            </div>

            <!-- Main Tab Navigation -->
            <div class="flex bg-stone-100 p-1 rounded-xl mb-3">
                <button 
                    v-for="tab in tabs" 
                    :key="tab.id"
                    @click="currentTab = tab.id"
                    class="flex-1 py-2 text-xs font-bold rounded-lg transition-all duration-200 flex items-center justify-center gap-1.5"
                    :class="currentTab === tab.id ? 'bg-white text-sumi shadow-sm' : 'text-stone-400 hover:text-stone-500'"
                >
                    <i :class="tab.icon"></i>
                    {{ tab.label }}
                </button>
            </div>

            <!-- Day Selector (Only visible in Itinerary tab) -->
            <div v-if="currentTab === 'itinerary'" class="relative -mx-6 transition-all duration-300"> 
                <div class="flex overflow-x-auto no-scrollbar snap-x-mandatory px-6 pb-2 gap-4" id="day-scroller">
                    <button 
                        v-for="(day, index) in days" 
                        :key="index"
                        @click="changeDay(index)"
                        class="snap-center flex-shrink-0 relative py-2 transition-all duration-300 group"
                    >
                        <div 
                            class="px-5 py-2 rounded-2xl text-sm transition-all duration-300 flex flex-col items-center min-w-[70px]"
                            :class="currentDayIndex === index ? 'bg-lake-400 text-white shadow-lg shadow-lake-200 scale-100' : 'bg-white text-stone-400 border border-stone-100 group-hover:border-lake-200'"
                        >
                            <span class="font-bold tracking-wide">Day {{ index + 1 }}</span>
                            <span class="text-[10px] font-normal mt-0.5 opacity-90">{{ getDayDateString(index, true) }}</span>
                        </div>
                    </button>
                    
                    <button @click="manualAddDay" class="snap-center flex-shrink-0 px-4 py-2 flex items-center justify-center">
                        <div class="w-10 h-10 rounded-full bg-white border border-dashed border-lake-300 text-lake-400 flex items-center justify-center hover:bg-lake-50 transition-colors">
                            <i class="fa-solid fa-plus"></i>
                        </div>
                    </button>
                    <div class="w-2 flex-shrink-0"></div>
                </div>
                <div class="absolute right-0 top-0 bottom-2 w-8 bg-gradient-to-l from-washi to-transparent pointer-events-none"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-hidden relative bg-washi">
            
            <!-- ====== ITINERARY TAB ====== -->
            <div v-if="currentTab === 'itinerary'" class="h-full relative">
                <!-- LIST VIEW -->
                <div v-show="viewMode === 'list'" class="absolute inset-0 overflow-y-auto p-4 pb-24 no-scrollbar" @scroll="checkScroll">
                    
                    <!-- TODAY'S WEATHER WIDGET -->
                    <div class="mb-4 bg-white/60 backdrop-blur-sm border border-stone-100 rounded-2xl p-3 flex items-center justify-between shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-lake-50 text-lake-400 flex items-center justify-center">
                                <i :class="getWeatherIcon(todayWeatherSummary?.code)" class="text-xl"></i>
                            </div>
                            <div>
                                <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest leading-none mb-1">Today's Nagoya</p>
                                <p class="text-sm font-bold text-sumi" v-if="todayWeatherSummary">
                                    {{ todayWeatherSummary.max }}° <span class="text-stone-300 font-normal">/</span> {{ todayWeatherSummary.min }}°
                                </p>
                                <p class="text-xs text-stone-300" v-else>Loading weather...</p>
                            </div>
                        </div>
                        <div class="text-right text-stone-300 text-[10px] font-bold uppercase tracking-widest">Nagoya, JP</div>
                    </div>

                    <!-- ARRIVAL FLIGHT CARD (Only Day 1) -->
                    <div v-if="currentDayIndex === 0" class="mb-6">
                        <div class="relative pl-10">
                            <div class="absolute left-0 top-6 w-10 h-10 flex items-center justify-center z-10">
                                <div class="w-8 h-8 rounded-full bg-lake-100 text-lake-500 flex items-center justify-center ring-4 ring-washi shadow-sm">
                                    <i class="fa-solid fa-plane-arrival text-xs"></i>
                                </div>
                            </div>
                            <div v-if="!arrivalFlight.code" class="bg-white p-5 rounded-[24px] shadow-[0_2px_15px_rgba(0,0,0,0.02)] border border-stone-50 border-dashed border-lake-200 flex items-center justify-center">
                                <button @click="openFlightModal('arrival')" class="flex items-center gap-2 text-lake-400 font-bold bg-lake-50 px-6 py-3 rounded-xl hover:bg-lake-100 transition-colors">
                                    <i class="fa-solid fa-plus"></i>
                                    設定去程航班資訊 (Manual)
                                </button>
                            </div>
                            <div v-else class="flight-card-bg p-5 rounded-[24px] shadow-md border border-white relative overflow-hidden group">
                                <div class="flex justify-between items-start relative z-10">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="bg-lake-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">Arrival</span>
                                            <span class="text-lake-600 font-bold text-lg font-mono">{{ arrivalFlight.code }}</span>
                                        </div>
                                        <h3 class="text-sumi font-bold text-sm mb-0.5">{{ arrivalFlight.title }}</h3>
                                        <p class="text-xs text-stone-400">{{ arrivalFlight.location }}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-sumi font-mono tracking-tight">{{ arrivalFlight.time }}</div>
                                        <div class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Estimated</div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-lake-100 flex items-center justify-between text-xs text-stone-500 relative z-10">
                                    <span class="flex items-center gap-1.5"><i class="fa-regular fa-clock text-lake-400"></i> {{ arrivalFlight.note }}</span>
                                    <button @click="openFlightModal('arrival')" class="text-stone-300 hover:text-lake-500 transition-colors px-2 py-1"><i class="fa-solid fa-pen"></i></button>
                                </div>
                                <i class="fa-solid fa-plane absolute -bottom-4 -right-4 text-[100px] text-lake-50 opacity-50 transform -rotate-45 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Timeline & Events -->
                    <div v-if="sortedEvents.length > 0" class="space-y-6 relative">
                        <div class="absolute left-[19px] top-0 bottom-0 w-px bg-stone-200/60"></div>
                        <transition-group name="slide-right" tag="div" class="space-y-6">
                            <div v-for="event in sortedEvents" :key="event.id" class="relative pl-10 group">
                                <div class="absolute left-0 top-3 w-10 h-10 flex items-center justify-center z-10">
                                    <div class="w-2.5 h-2.5 rounded-full ring-4 ring-washi transition-colors duration-300" :class="getTypeColor(event.type, 'dot')"></div>
                                </div>
                                <div class="bg-white shadow-lg border border-stone-50 active:scale-[0.98] transition-all duration-200 relative overflow-hidden hover:shadow-xl rounded-[24px] flex flex-col" @click="editEvent(event)">
                                    <div class="py-2 px-4 rounded-t-[24px] flex justify-between items-center text-white" :class="getTypeColor(event.type, 'header')">
                                        <span class="text-lg font-bold font-mono tracking-tight">{{ event.time }}<span v-if="event.endTime"> - {{ event.endTime }}</span></span>
                                        <span class="text-xs font-bold tracking-widest">{{ getTypeName(event.type) }}</span>
                                    </div>
                                    <div class="flex-1 p-5 pt-4 flex flex-col justify-start"> 
                                        <div class="flex justify-between items-start mb-2">
                                            <h3 class="text-xl font-bold text-sumi leading-snug flex-shrink-0 mr-4 max-w-[70%]">{{ event.title }}</h3>
                                            <span v-if="event.endTime" class="text-sm font-medium text-stone-400 whitespace-nowrap pt-1">{{ formatDuration(event.time, event.endTime) }}</span>
                                        </div>
                                        <div class="flex items-center justify-between text-stone-400 text-xs font-normal mt-1 mb-2">
                                            <div class="flex items-center max-w-[80%]">
                                                <i class="fa-solid fa-location-dot mr-1.5 opacity-50 flex-shrink-0"></i>
                                                <span class="truncate">{{ event.location }}</span>
                                            </div>
                                            <a :href="getMapUrl(event.location)" target="_blank" @click.stop class="w-8 h-8 flex items-center justify-center rounded-full bg-stone-50 text-stone-300 hover:bg-lake-50 hover:text-lake-400 transition-colors flex-shrink-0">
                                                <i class="fa-solid fa-location-arrow text-xs"></i>
                                            </a>
                                        </div>
                                        <p v-if="event.note" class="text-stone-400 text-xs mt-3 pt-3 border-t border-stone-50/80 leading-relaxed font-normal">{{ event.note }}</p>
                                    </div>
                                    <div v-if="getEventWeather(event.time)" class="absolute bottom-4 right-4 flex items-center text-xs text-lake-400 bg-lake-50/50 px-2 py-1 rounded-lg backdrop-blur-sm pointer-events-none">
                                        <i :class="getWeatherIcon(getEventWeather(event.time).code)" class="mr-1.5"></i>
                                        <span>{{ getEventWeather(event.time).temp }}°</span>
                                    </div>
                                </div>
                            </div>
                        </transition-group>
                    </div>

                    <!-- Empty State -->
                    <div v-else class="flex flex-col items-center justify-center py-20 text-stone-300">
                        <div class="w-20 h-20 bg-white rounded-full flex items-center justify-center shadow-[0_4px_20px_rgba(0,0,0,0.03)] mb-4 animate-pulse">
                            <i class="fa-regular fa-map text-2xl text-lake-200"></i>
                        </div>
                        <p class="font-normal tracking-widest text-sm uppercase">Plan your journey</p>
                    </div>

                    <!-- DEPARTURE FLIGHT CARD (Only Last Day) -->
                    <div v-if="currentDayIndex === days.length - 1" class="mt-6">
                        <div class="relative pl-10">
                            <div class="absolute left-0 top-6 w-10 h-10 flex items-center justify-center z-10">
                                <div class="w-8 h-8 rounded-full bg-stone-100 text-stone-500 flex items-center justify-center ring-4 ring-washi shadow-sm">
                                    <i class="fa-solid fa-plane-departure text-xs"></i>
                                </div>
                            </div>
                            <div v-if="!departureFlight.code" class="bg-white p-5 rounded-[24px] shadow-[0_2px_15px_rgba(0,0,0,0.02)] border border-stone-50 border-dashed border-stone-200 flex items-center justify-center">
                                <button @click="openFlightModal('departure')" class="flex items-center gap-2 text-stone-400 font-bold bg-stone-50 px-6 py-3 rounded-xl hover:bg-stone-100 transition-colors">
                                    <i class="fa-solid fa-plus"></i>
                                    設定回程航班資訊 (Manual)
                                </button>
                            </div>
                            <div v-else class="flight-card-bg p-5 rounded-[24px] shadow-md border border-white relative overflow-hidden group">
                                <div class="flex justify-between items-start relative z-10">
                                    <div>
                                        <div class="flex items-center gap-2 mb-1">
                                            <span class="bg-stone-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-wider">Return</span>
                                            <span class="text-stone-600 font-bold text-lg font-mono">{{ departureFlight.code }}</span>
                                        </div>
                                        <h3 class="text-sumi font-bold text-sm mb-0.5">{{ departureFlight.title }}</h3>
                                        <p class="text-xs text-stone-400">{{ departureFlight.location }}</p>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-lg font-bold text-sumi font-mono tracking-tight">{{ departureFlight.time }}</div>
                                        <div class="text-[10px] text-stone-400 uppercase tracking-widest font-bold">Departure</div>
                                    </div>
                                </div>
                                <div class="mt-4 pt-3 border-t border-lake-100 flex items-center justify-between text-xs text-stone-500 relative z-10">
                                    <span class="flex items-center gap-1.5"><i class="fa-regular fa-clock text-stone-400"></i> {{ departureFlight.note }}</span>
                                    <button @click="openFlightModal('departure')" class="text-stone-300 hover:text-stone-500 transition-colors px-2 py-1"><i class="fa-solid fa-pen"></i></button>
                                </div>
                                <i class="fa-solid fa-plane-departure absolute -bottom-4 -right-4 text-[100px] text-stone-100 opacity-50 transform -rotate-12 pointer-events-none"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MAP VIEW -->
                <div v-show="viewMode === 'map'" class="absolute inset-0 bg-stone-100">
                    <div id="map-container"></div>
                </div>
            </div>

            <!-- ====== SHOPPING LISTS (XUAN & CHIAU) ====== -->
            <template v-for="user in ['xuan', 'chiau']" :key="user">
                <div v-if="currentTab === user" class="absolute inset-0 overflow-y-auto p-4 pb-24 bg-washi no-scrollbar">
                    <div class="bg-white p-6 rounded-[32px] shadow-sm border border-stone-50 min-h-[400px]">
                        <h2 class="text-xl font-bold text-sumi mb-4 flex items-center gap-2">
                            <span class="w-8 h-8 rounded-full flex items-center justify-center text-sm" :class="user === 'xuan' ? 'bg-pink-100 text-pink-500' : 'bg-indigo-100 text-indigo-500'">
                                <i class="fa-solid" :class="user === 'xuan' ? 'fa-bag-shopping' : 'fa-cart-shopping'"></i>
                            </span>
                            {{ user === 'xuan' ? 'Xuan' : 'Chiau' }} 的購物清單
                        </h2>
                        
                        <!-- Input Section -->
                        <div class="space-y-2 mb-8 bg-stone-50/50 p-4 rounded-2xl border border-stone-100">
                            <input v-model="newItemText[user]" @keydown.enter="addShoppingItem(user)" type="text" placeholder="想買什麼？ (例如：維他命)" class="w-full bg-white border border-stone-100 rounded-xl px-4 py-3 text-sm outline-none shadow-sm focus:ring-2" :class="user === 'xuan' ? 'focus:ring-pink-200' : 'focus:ring-indigo-200'">
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input v-model="newItemCategory[user]" @keydown.enter="addShoppingItem(user)" type="text" placeholder="分類 (點擊預設或手打)" class="w-full bg-white border border-stone-100 rounded-xl px-4 py-3 text-sm outline-none shadow-sm focus:ring-2 pr-10" :class="user === 'xuan' ? 'focus:ring-pink-200' : 'focus:ring-indigo-200'">
                                </div>
                                <button @click="addShoppingItem(user)" class="w-12 h-11 rounded-xl text-white shadow-lg flex items-center justify-center flex-shrink-0" :class="user === 'xuan' ? 'bg-pink-400 shadow-pink-100 hover:bg-pink-500' : 'bg-indigo-400 shadow-indigo-100 hover:bg-indigo-500'">
                                    <i class="fa-solid fa-plus"></i>
                                </button>
                            </div>
                            <!-- Category Quick Selection Chips -->
                            <div class="flex flex-wrap gap-1.5 mt-2">
                                <button v-for="c in ['藥妝','伴手禮','玩具','食物','其他']" :key="c" @click="newItemCategory[user] = c" class="text-[10px] px-2 py-1 rounded-full border border-stone-200 text-stone-400 hover:border-lake-300 hover:text-lake-400 bg-white transition-all">{{ c }}</button>
                            </div>
                        </div>

                        <!-- Grouped List Display -->
                        <div class="space-y-8">
                            <div v-for="(group, catName) in currentGroupedList(user)" :key="catName" class="space-y-3">
                                <div class="flex items-center gap-3 px-1">
                                    <h3 class="text-sm font-bold text-sumi tracking-wider">{{ catName }}</h3>
                                    <div class="flex-1 h-px bg-stone-100 mt-0.5"></div>
                                    <span class="text-[10px] font-bold text-stone-300 uppercase tracking-tighter">{{ group.length }} items</span>
                                </div>
                                <div 
                                    v-for="item in group" 
                                    :key="item.id" 
                                    class="shopping-item flex items-center gap-3 p-3.5 rounded-2xl bg-white group border border-stone-50 shadow-sm"
                                    @touchstart="startLongPress(user, item)"
                                    @touchend="cancelLongPress"
                                    @mousedown="startLongPress(user, item)"
                                    @mouseup="cancelLongPress"
                                >
                                    <label class="checkbox-wrapper cursor-pointer relative w-6 h-6">
                                        <input type="checkbox" v-model="item.checked" @change="saveToCloud()" class="opacity-0 absolute w-full h-full cursor-pointer">
                                        <div class="w-6 h-6 border-2 border-stone-200 rounded-lg flex items-center justify-center transition-all bg-stone-50">
                                            <svg class="w-3.5 h-3.5 text-white hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                                        </div>
                                    </label>
                                    <span class="flex-1 text-sm font-medium" :class="item.checked ? 'text-stone-300 line-through' : 'text-sumi'">{{ item.text }}</span>
                                    <button @click="confirmAction('deleteItem', {who: user, id: item.id})" class="text-stone-300 hover:text-red-400 p-2 rounded-full opacity-0 group-hover:opacity-100">
                                        <i class="fa-solid fa-trash-can"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="(user === 'xuan' ? xuanList : chiauList).length === 0" class="flex flex-col items-center justify-center py-20 opacity-30">
                                <i class="fa-solid fa-clipboard-list text-3xl mb-3"></i>
                                <p class="text-xs font-bold uppercase tracking-widest text-center">清單目前是空的<br><small class="font-normal">( 長按項目可移動分類 )</small></p>
                            </div>
                        </div>
                    </div>
                </div>
            </template>

        </main>

        <!-- MOVE CATEGORY MODAL (Long Press) -->
        <transition name="fade">
            <div v-if="moveModal.show" class="absolute inset-0 z-[100] flex items-end sm:items-center justify-center p-4 bg-stone-900/40 backdrop-blur-sm" @click.self="moveModal.show = false">
                <div class="bg-white w-full max-w-xs rounded-[32px] overflow-hidden shadow-2xl slide-up-animation">
                    <div class="p-6 pb-2">
                        <p class="text-[10px] font-bold text-stone-300 uppercase tracking-widest mb-1">移動項目分類</p>
                        <h3 class="text-lg font-bold text-sumi mb-4 truncate">「{{ moveModal.item?.text }}」</h3>
                    </div>
                    <div class="max-h-60 overflow-y-auto no-scrollbar px-4 pb-4">
                        <div class="space-y-1">
                            <button 
                                v-for="cat in availableCategories" 
                                :key="cat"
                                @click="moveItemTo(cat)"
                                class="w-full text-left p-3.5 rounded-xl text-sm font-medium hover:bg-stone-50 transition-colors flex items-center justify-between"
                                :class="moveModal.item?.category === cat ? 'text-lake-500 bg-lake-50/50' : 'text-stone-600'"
                            >
                                {{ cat }}
                                <i v-if="moveModal.item?.category === cat" class="fa-solid fa-check text-xs"></i>
                            </button>
                            <button @click="promptNewCategory" class="w-full text-left p-3.5 rounded-xl text-sm font-bold text-lake-400 border border-dashed border-lake-100 hover:bg-lake-50 mt-2">
                                <i class="fa-solid fa-plus mr-2"></i>新增其他分類...
                            </button>
                        </div>
                    </div>
                    <div class="p-4 bg-stone-50/50">
                        <button @click="moveModal.show = false" class="w-full py-3 text-stone-400 font-bold text-sm">取消</button>
                    </div>
                </div>
            </div>
        </transition>

        <!-- Modals for Events & Flight -->
        <transition name="slide-up">
            <div v-if="showModal && !isFlightMode" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div @click="closeModal" class="absolute inset-0 bg-stone-900/20 backdrop-blur-sm pointer-events-auto"></div>
                <div class="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-8 pointer-events-auto shadow-2xl relative max-h-[90vh] overflow-y-auto no-scrollbar">
                    <div class="w-12 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-xl font-bold text-sumi tracking-wide">{{ isEditing ? '編輯行程' : '新增行程' }}</h2>
                        <button @click="closeModal" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 flex items-center justify-center hover:bg-stone-100"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <form @submit.prevent="saveEvent" class="space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">開始時間</label>
                                <div class="flex gap-2">
                                    <select v-model="form.hour" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm appearance-none text-center">
                                        <option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option>
                                    </select>
                                    <span class="py-3 text-stone-300">:</span>
                                    <select v-model="form.minute" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm appearance-none text-center">
                                        <option v-for="m in 12" :key="m-1" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-span-3">
                                <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">類別</label>
                                <select v-model="form.type" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm appearance-none focus:ring-2 focus:ring-lake-200">
                                    <option value="sightseeing">景點 Sightseeing</option>
                                    <option value="food">美食 Food</option>
                                    <option value="shopping">購物 Shopping</option>
                                    <option value="transport">交通 Transport</option>
                                    <option value="hotel">住宿 Hotel</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">結束時間</label>
                            <div class="flex gap-2">
                                <select v-model="form.endHour" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm appearance-none text-center">
                                    <option v-for="h in 24" :key="h-1" :value="(h-1).toString().padStart(2, '0')">{{ (h-1).toString().padStart(2, '0') }}</option>
                                </select>
                                <span class="py-3 text-stone-300">:</span>
                                <select v-model="form.endMinute" class="flex-1 bg-stone-50 border-none rounded-xl px-2 py-3 text-sumi font-mono text-sm appearance-none text-center">
                                    <option v-for="m in 12" :key="m-1" :value="((m-1)*5).toString().padStart(2, '0')">{{ ((m-1)*5).toString().padStart(2, '0') }}</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">標題</label>
                            <input v-model="form.title" type="text" placeholder="要去哪裡呢？" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm focus:ring-2 focus:ring-lake-200">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">地點</label>
                            <div class="relative">
                                <input v-model="form.location" type="text" placeholder="地點名稱..." class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 pl-10 text-sumi text-sm focus:ring-2 focus:ring-lake-200">
                                <i class="fa-solid fa-map-pin absolute left-4 top-3.5 text-stone-300 text-sm"></i>
                            </div>
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">備註</label>
                            <textarea v-model="form.note" rows="3" placeholder="補充資訊..." class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm resize-none"></textarea>
                        </div>
                        <div class="pt-6 flex gap-3">
                            <button v-if="isEditing" type="button" @click="confirmAction('deleteEvent')" class="w-12 h-12 rounded-xl bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition-colors"><i class="fa-regular fa-trash-can"></i></button>
                            <button type="submit" class="flex-1 bg-lake-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-lake-200 hover:bg-lake-500 transition-all">{{ isEditing ? '儲存變更' : '加入行程' }}</button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

        <!-- Flight Modal -->
        <transition name="slide-up">
            <div v-if="showModal && isFlightMode" class="absolute inset-0 z-50 flex items-end sm:items-center justify-center pointer-events-none">
                <div @click="closeModal" class="absolute inset-0 bg-stone-900/20 backdrop-blur-sm pointer-events-auto"></div>
                <div class="bg-white w-full max-w-md rounded-t-[32px] sm:rounded-[32px] p-8 pointer-events-auto shadow-2xl relative max-h-[90vh] overflow-y-auto no-scrollbar">
                    <div class="w-12 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>
                    <div class="flex justify-between items-center mb-8">
                        <h2 class="text-xl font-bold text-sumi tracking-wide">{{ editingFlightType === 'arrival' ? '去程航班' : '回程航班' }}</h2>
                        <button @click="closeModal" class="w-8 h-8 rounded-full bg-stone-50 text-stone-400 flex items-center justify-center hover:bg-stone-100"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <form @submit.prevent="saveFlight" class="space-y-6">
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">航班代號</label>
                            <input v-model="flightForm.code" type="text" placeholder="e.g. JX838" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm uppercase font-mono">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">航空公司 / 標題</label>
                            <input v-model="flightForm.title" type="text" placeholder="e.g. 星宇航空" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">起降時間</label>
                            <input v-model="flightForm.time" type="text" placeholder="e.g. 14:55 - 18:30" required class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm">
                        </div>
                        <div>
                            <label class="block text-[10px] font-bold text-stone-400 uppercase mb-2 tracking-widest">機場 / 地點</label>
                            <input v-model="flightForm.location" type="text" placeholder="中部國際機場 (NGO)" class="w-full bg-stone-50 border-none rounded-xl px-4 py-3 text-sumi text-sm">
                        </div>
                        <div class="pt-6 flex gap-3">
                            <button type="button" @click="confirmAction('clearFlight')" class="w-12 h-12 rounded-xl bg-red-50 text-red-400 flex items-center justify-center hover:bg-red-100 transition-colors"><i class="fa-regular fa-trash-can"></i></button>
                            <button type="submit" class="flex-1 bg-lake-400 text-white py-3 rounded-xl font-bold shadow-lg shadow-lake-200 hover:bg-lake-500 transition-all">儲存航班資訊</button>
                        </div>
                    </form>
                </div>
            </div>
        </transition>

    </div>
</div>

<script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;

    createApp({
        setup() {
            // --- Configuration ---
            const SUPABASE_URL = 'https://nrormwhklkytqyrbrdbr.supabase.co';
            const SUPABASE_KEY = 'sb_publishable_QuvW2VoIHavfZ7RunbOl1A_Fu34ri_D';
            const TRIP_ID = 'nagoya_main';
            const defaultCategories = ['藥妝', '伴手禮', '玩具', '食物', '其他'];

            // --- App State ---
            const days = ref([{ date: 'Day 1', events: [] }]);
            const currentDayIndex = ref(0);
            const showModal = ref(false);
            const isEditing = ref(false);
            const isFlightMode = ref(false); 
            const editingFlightType = ref(''); 
            const tripTitle = ref('Nagoya.Go');
            const confirmState = ref({ show: false, message: '', type: '', payload: null });
            const currentTab = ref('itinerary');
            const status = ref('disconnected');
            const isScrolled = ref(false);
            const viewMode = ref('list');
            const startDate = ref(new Date().toISOString().split('T')[0]);
            const endDate = ref('');
            const weatherData = ref(null);
            
            const tabs = [
                { id: 'itinerary', label: '行程', icon: 'fa-solid fa-calendar-days' },
                { id: 'xuan', label: 'Xuan', icon: 'fa-solid fa-user' },
                { id: 'chiau', label: 'Chiau', icon: 'fa-solid fa-user' },
            ];

            // --- Shopping State ---
            const xuanList = ref([]);
            const chiauList = ref([]);
            const newItemText = ref({ xuan: '', chiau: '' });
            const newItemCategory = ref({ xuan: '', chiau: '' });
            
            const moveModal = ref({ show: false, user: '', item: null });
            let longPressTimer = null;

            const arrivalFlight = ref({ code: '', time: '', title: '', location: '', note: '' });
            const departureFlight = ref({ code: '', time: '', title: '', location: '', note: '' });
            const flightForm = ref({ code: '', time: '', title: '', location: '', note: '' });
            const form = ref({ 
                id: null, time: '09:00', endTime: '10:00', hour: '09', minute: '00', endHour: '10', endMinute: '00',
                type: 'sightseeing', title: '', location: '', note: '' 
            });

            // --- Methods: Shopping Logic ---
            const addShoppingItem = (who) => {
                const text = newItemText.value[who].trim();
                const category = newItemCategory.value[who].trim() || '未分類';
                if (!text) return;

                const item = { id: Date.now(), text, category, checked: false };
                if (who === 'xuan') xuanList.value.push(item); else chiauList.value.push(item);
                
                newItemText.value[who] = '';
                // Category is kept for continuous input
                saveToCloud();
            };

            const currentGroupedList = (who) => {
                const list = who === 'xuan' ? xuanList.value : chiauList.value;
                if (!list || list.length === 0) return {};
                
                const groups = {};
                list.forEach(item => {
                    const cat = item.category || '未分類';
                    if (!groups[cat]) groups[cat] = [];
                    groups[cat].push(item);
                });
                return groups;
            };

            const availableCategories = computed(() => {
                const list = moveModal.value.user === 'xuan' ? xuanList.value : chiauList.value;
                const existingCats = list.map(i => i.category || '未分類');
                // Merge default and existing categories
                const all = [...new Set([...defaultCategories, ...existingCats])];
                // Ensure "未分類" is at the end
                return all.filter(c => c !== '未分類').concat(['未分類']);
            });

            const startLongPress = (user, item) => {
                longPressTimer = setTimeout(() => {
                    moveModal.value = { show: true, user, item };
                }, 600);
            };

            const cancelLongPress = () => {
                if (longPressTimer) clearTimeout(longPressTimer);
            };

            const moveItemTo = (newCat) => {
                if (!moveModal.value.item) return;
                moveModal.value.item.category = newCat;
                saveToCloud();
                moveModal.value.show = false;
            };

            const promptNewCategory = () => {
                const newCat = prompt("請輸入新分類名稱：");
                if (newCat && newCat.trim()) {
                    moveItemTo(newCat.trim());
                }
            };

            // --- Methods: Common ---
            const confirmAction = (type, payload = null) => {
                confirmState.value = { show: true, type, payload, message: '' };
                if (type === 'deleteEvent') confirmState.value.message = '確定要刪除這個行程嗎？';
                else if (type === 'deleteItem') confirmState.value.message = '確定要刪除此購物項目？';
                else if (type === 'clearFlight') confirmState.value.message = '確定要清除此航班資訊？';
                else if (type === 'reset') confirmState.value.message = '這將清除所有資料並重置。確定？';
            };

            const executeConfirm = () => {
                const { type, payload } = confirmState.value;
                confirmState.value.show = false;
                if (type === 'deleteEvent') {
                    const evs = days.value[currentDayIndex.value].events;
                    const idx = evs.findIndex(x => x.id === form.value.id);
                    if (idx !== -1) evs.splice(idx, 1);
                    saveToCloud(); closeModal();
                } else if (type === 'deleteItem') {
                    const list = payload.who === 'xuan' ? xuanList : chiauList;
                    const idx = list.value.findIndex(x => x.id === payload.id);
                    if (idx !== -1) list.value.splice(idx, 1);
                    saveToCloud();
                } else if (type === 'clearFlight') {
                    const target = editingFlightType.value === 'arrival' ? arrivalFlight : departureFlight;
                    target.value = { code: '', time: '', title: '', location: '', note: '' };
                    saveToCloud(); closeModal();
                } else if (type === 'reset') {
                    saveToCloud(true); currentDayIndex.value = 0; viewMode.value = 'list';
                }
            };

            // --- Weather ---
            const todayWeatherSummary = computed(() => {
                if (!weatherData.value || !weatherData.value.daily) return null;
                const todayStr = new Date().toISOString().split('T')[0];
                const index = weatherData.value.daily.time.indexOf(todayStr);
                const targetIdx = index !== -1 ? index : 0;
                return {
                    max: Math.round(weatherData.value.daily.temperature_2m_max[targetIdx]),
                    min: Math.round(weatherData.value.daily.temperature_2m_min[targetIdx]),
                    code: weatherData.value.daily.weathercode?.[targetIdx] || 0
                };
            });

            const getEventWeather = (timeStr) => {
                if (!weatherData.value || !startDate.value) return null;
                const d = new Date(startDate.value); d.setDate(d.getDate() + currentDayIndex.value);
                const hour = timeStr.split(':')[0].padStart(2, '0');
                const key = `${d.toISOString().split('T')[0]}T${hour}:00`;
                const idx = weatherData.value.hourly?.time.indexOf(key);
                if (idx !== -1) return { temp: Math.round(weatherData.value.hourly.temperature_2m[idx]), code: weatherData.value.hourly.weathercode[idx] };
                return null;
            };

            const getWeatherIcon = (code) => {
                const map = { 0: 'fa-sun', 1: 'fa-sun', 2: 'fa-cloud-sun', 3: 'fa-cloud', 45: 'fa-smog', 48: 'fa-smog', 51: 'fa-cloud-rain', 53: 'fa-cloud-rain', 55: 'fa-cloud-rain', 61: 'fa-umbrella', 63: 'fa-umbrella', 65: 'fa-umbrella', 80: 'fa-cloud-showers-heavy', 81: 'fa-cloud-showers-heavy', 82: 'fa-cloud-showers-heavy', 95: 'fa-bolt' };
                return `fa-solid ${map[code] || 'fa-cloud'}`;
            };

            // --- Supabase ---
            let supabase = null;
            const saveToCloud = async (forceReset = false) => {
                if (!supabase) return;
                status.value = 'loading';
                const content = forceReset ? { tripTitle: 'Nagoya.Go', days: [{ date: 'Day 1', events: [] }], xuanList: [], chiauList: [] } : { 
                    tripTitle: tripTitle.value, startDate: startDate.value, endDate: endDate.value, 
                    days: days.value, xuanList: xuanList.value, chiauList: chiauList.value,
                    arrivalFlight: arrivalFlight.value, departureFlight: departureFlight.value
                };
                if(forceReset) { days.value = content.days; xuanList.value = []; chiauList.value = []; }
                const { error } = await supabase.from('trip_plans').upsert({ id: TRIP_ID, content });
                status.value = error ? 'error' : 'connected';
            };

            const initSupabase = async () => {
                const { createClient } = window.supabase;
                supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
                const { data } = await supabase.from('trip_plans').select('content').eq('id', TRIP_ID).maybeSingle();
                if (data?.content) {
                    days.value = data.content.days || [{ date: 'Day 1', events: [] }];
                    tripTitle.value = data.content.tripTitle || 'Nagoya.Go';
                    startDate.value = data.content.startDate || new Date().toISOString().split('T')[0];
                    endDate.value = data.content.endDate || '';
                    xuanList.value = data.content.xuanList || [];
                    chiauList.value = data.content.chiauList || [];
                    arrivalFlight.value = data.content.arrivalFlight || { code: '' };
                    departureFlight.value = data.content.departureFlight || { code: '' };
                }
                status.value = 'connected';
            };

            // --- Helpers ---
            const formatDuration = (s, e) => {
                if(!s || !e) return '';
                const [sh, sm] = s.split(':').map(Number), [eh, em] = e.split(':').map(Number);
                let diff = (eh * 60 + em) - (sh * 60 + sm);
                if(diff < 0) diff += 1440;
                const h = Math.floor(diff/60), m = diff%60;
                return `${h?h+'hr ':''}${m?m+'min':''}`;
            };

            const getTypeColor = (t, m) => {
                const colors = { sightseeing: 'lake-400', food: 'orange-400', shopping: 'pink-400', transport: 'stone-400', hotel: 'indigo-400' };
                const c = colors[t] || colors.sightseeing;
                return m === 'dot' ? 'bg-'+c : (m === 'header' ? 'bg-'+c : 'text-'+c);
            };

            const getTypeName = (t) => ({ sightseeing: '景點', food: '美食', shopping: '購物', transport: '交通', hotel: '住宿' }[t] || '行程');
            const getDayDateString = (i, s) => {
                const d = new Date(startDate.value); d.setDate(d.getDate() + i);
                return `${d.getMonth()+1}/${d.getDate()}${s?' '+['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][d.getDay()]:''}`;
            };
            const closeModal = () => showModal.value = false;
            const openAddModal = () => { isFlightMode.value = false; isEditing.value = false; form.value = { id: Date.now(), time: '09:00', endTime: '10:00', hour: '09', minute: '00', endHour: '10', endMinute: '00', type: 'sightseeing', title: '', location: '', note: '' }; showModal.value = true; };
            const editEvent = (e) => { isFlightMode.value = false; isEditing.value = true; const [h, m] = e.time.split(':'), [eh, em] = e.endTime.split(':'); form.value = { ...e, hour: h, minute: m, endHour: eh, endMinute: em }; showModal.value = true; };
            const saveEvent = () => {
                form.value.time = `${form.value.hour}:${form.value.minute}`; form.value.endTime = `${form.value.endHour}:${form.value.endMinute}`;
                const evs = days.value[currentDayIndex.value].events;
                if(isEditing.value) { const idx = evs.findIndex(x => x.id === form.value.id); evs[idx] = { ...form.value }; } else { evs.push({ ...form.value }); }
                saveToCloud(); closeModal();
            };
            const openFlightModal = (t) => { isFlightMode.value = true; editingFlightType.value = t; flightForm.value = { ...(t === 'arrival' ? arrivalFlight.value : departureFlight.value) }; showModal.value = true; };
            const saveFlight = () => { if(editingFlightType.value === 'arrival') arrivalFlight.value = { ...flightForm.value }; else departureFlight.value = { ...flightForm.value }; saveToCloud(); closeModal(); };
            const manualAddDay = () => { days.value.push({ date: `Day ${days.value.length+1}`, events: [] }); saveToCloud(); };
            const changeDay = (i) => currentDayIndex.value = i;
            const fetchWeather = async () => {
                try {
                    const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=35.18&longitude=136.91&hourly=temperature_2m,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=Asia%2FTokyo&forecast_days=16`);
                    weatherData.value = await res.json();
                } catch(e) { console.error(e); }
            };

            onMounted(() => { initSupabase(); fetchWeather(); });

            return {
                days, currentDayIndex, showModal, isEditing, form, startDate, endDate, tripTitle, status, viewMode, isScrolled, currentTab, tabs, xuanList, chiauList, newItemText, newItemCategory, arrivalFlight, departureFlight, flightForm, confirmState, todayWeatherSummary, moveModal, availableCategories,
                confirmAction, executeConfirm, addShoppingItem, currentGroupedList, formatDuration, getTypeColor, getTypeName, getDayDateString, getEventWeather, getWeatherIcon, openAddModal, editEvent, closeModal, saveEvent, saveToCloud, openFlightModal, saveFlight, manualAddDay, changeDay, startLongPress, cancelLongPress, moveItemTo, promptNewCategory,
                sortedEvents: computed(() => [...(days.value[currentDayIndex.value]?.events || [])].sort((a, b) => a.time.localeCompare(b.time))),
                getMapUrl: (l) => l ? `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(l)}` : '#',
                toggleViewMode: () => viewMode.value = viewMode.value === 'list' ? 'map' : 'list',
                checkScroll: (e) => isScrolled.value = e.target.scrollTop > 10,
                handleDateChange: () => saveToCloud()
            };
        }
    }).mount('#app');
</script>
